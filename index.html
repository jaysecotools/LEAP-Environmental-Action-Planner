<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAP - Landholder Environmental Action Planner</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link 
      rel="stylesheet" 
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <link href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" rel="stylesheet"/>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.umd.js"></script>
    <link href="https://unpkg.com/leaflet-geosearch@3.8.0/assets/css/leaflet.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; }
        .leaflet-top { z-index: 500 !important; }
        .help-tooltip {
            cursor: help;
            border-bottom: 1px dotted #999;
        }
        .zone-management { background-color: rgba(51, 136, 255, 0.2); border-color: #3388ff; }
        .zone-problem { background-color: rgba(255, 0, 0, 0.2); border-color: #ff0000; }
        .zone-sensitive { background-color: rgba(51, 204, 51, 0.2); border-color: #33cc33; }
        .zone-other { background-color: rgba(255, 204, 0, 0.2); border-color: #ffcc00; }
        .leaflet-control-layers-toggle {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>');
            background-size: 70%;
        }
        .zone-label-text {
            background-color: white;
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid #333;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
        .pdf-title {
            color: #1a3e1a;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .pdf-heading {
            color: #1a3e1a;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        .pdf-subheading {
            color: #2d3748;
            font-size: 14px;
            font-weight: bold;
            margin-top: 12px;
            margin-bottom: 6px;
        }
        .pdf-text {
            color: #4a5568;
            font-size: 12px;
            line-height: 1.5;
        }
        .pdf-list-item {
            color: #4a5568;
            font-size: 12px;
            margin-left: 15px;
            line-height: 1.5;
        }
        .pdf-highlight {
            background-color: #f0fff4;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Utility functions
    const formatDate = (date) => {
        return new Date(date).toLocaleDateString('en-AU', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };

    // Sample data for demonstration
    const sampleWeeds = {
        'NSW': ['African lovegrass', 'Blackberry', 'Gorse', 'Lantana', 'Serrated tussock'],
        'VIC': ['Bridal creeper', 'Gorse', 'Paterson\'s curse', 'Willows', 'English broom'],
        'QLD': ['Lantana', 'Parthenium weed', 'Pond apple', 'Rubber vine', 'Singapore daisy'],
        'WA': ['Arum lily', 'Bridal creeper', 'Watsonia', 'Geraldton carnation weed', 'Ehrharta'],
        'SA': ['Olive', 'Bridal creeper', 'Geraldton carnation weed', 'Buffel grass', 'Horehound'],
        'TAS': ['Gorse', 'Broom', 'Willows', 'Holly', 'Spanish heath'],
        'NT': ['Gamba grass', 'Parkinsonia', 'Rubber vine', 'Pond apple', 'Mimosa pigra']
    };

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
        constructor(props) {
            super(props);
            this.state = { hasError: false };
        }

        static getDerivedStateFromError(error) {
            return { hasError: true };
        }

        componentDidCatch(error, errorInfo) {
            console.error("Error caught by boundary:", error, errorInfo);
        }

        render() {
            if (this.state.hasError) {
                return <div className="p-4 bg-red-100 text-red-800">
                    <h3>Something went wrong</h3>
                    <p>Please try refreshing the page or going back.</p>
                </div>;
            }
            return this.props.children;
        }
    }

    // Main App Component
    function App() {
        const [currentStep, setCurrentStep] = useState(0);
        const [formData, setFormData] = useState({
            property: {
                name: '',
                size: '',
                location: '',
                state: '',
                features: [],
                rainfall: '',
                soilType: '',
                coordinates: null // Added for geolocation
            },
            problems: {
                erosion: { present: false, severity: 'low' },
                weeds: [],
                habitatLoss: { present: false, severity: 'low' },
                waterQuality: { present: false, severity: 'low' },
                fireRisk: { present: false, severity: 'low' },
                otherProblems: '',
                goals: []
            },
            mapZones: [],
            recommendations: [],
            timeline: [],
            photos: [] // Added for photo storage
        });

        const steps = [
            { title: 'Welcome', icon: '🏠' },
            { title: 'Property Details', icon: '📋' },
            { title: 'Identify Problems', icon: '⚠️' },
            { title: 'Map Your Property', icon: '🗺️' },
            { title: 'Recommendations', icon: '💡' },
            { title: 'Action Timeline', icon: '📅' },
            { title: 'Export Plan', icon: '📤' }
        ];

        const propertyFeatures = [
            'Creeks or rivers',
            'Native vegetation',
            'Wetlands',
            'Rocky outcrops',
            'Existing fencing',
            'Farm infrastructure',
            'Pasture areas',
            'Forest/woodland'
        ];

        const managementGoals = [
            'Improve biodiversity',
            'Control invasive species',
            'Reduce erosion',
            'Improve water quality',
            'Enhance farm productivity',
            'Create wildlife habitat',
            'Reduce fire risk',
            'Carbon sequestration'
        ];

        const nextStep = () => {
            if (currentStep === 1 && !formData.property.name) {
                alert('Please at least provide a property name');
                return;
            }
            setCurrentStep(prev => Math.min(prev + 1, steps.length - 1));
        };
        
        const prevStep = () => setCurrentStep(prev => Math.max(prev - 1, 0));

        const updateFormData = (section, data) => {
            setFormData(prev => ({
                ...prev,
                [section]: { ...prev[section], ...data }
            }));
        };

        const addMapZone = (zone) => {
            setFormData(prev => ({
                ...prev,
                mapZones: [...prev.mapZones, zone]
            }));
        };

        const updateZone = (id, updates) => {
            setFormData(prev => ({
                ...prev,
                mapZones: prev.mapZones.map((zone, index) => 
                    index === id ? { ...zone, ...updates } : zone
                )
            }));
        };

        const removeZone = (id) => {
            setFormData(prev => ({
                ...prev,
                mapZones: prev.mapZones.filter((_, index) => index !== id)
            }));
        };

        const addPhoto = (photo) => {
            setFormData(prev => ({
                ...prev,
                photos: [...prev.photos, photo]
            }));
        };

        const removePhoto = (index) => {
            setFormData(prev => ({
                ...prev,
                photos: prev.photos.filter((_, i) => i !== index)
            }));
        };

        const generateRecommendations = () => {
            const recs = [];
            const timeline = [];
            const now = new Date();
            
            // Weed management recommendations
            if (formData.problems.weeds.length > 0) {
                const weedActions = [];
                
                if (formData.problems.weeds.some(w => ['Gorse', 'Blackberry', 'Lantana'].includes(w))) {
                    weedActions.push('Mechanical removal followed by herbicide application');
                    timeline.push({
                        action: 'Initial weed control',
                        timeframe: '1-3 months',
                        season: formData.property.state === 'TAS' ? 'Spring' : 'Late winter',
                        priority: 'high'
                    });
                }
                
                if (formData.problems.weeds.some(w => ['Serrated tussock', 'African lovegrass'].includes(w))) {
                    weedActions.push('Pasture improvement to outcompete weeds');
                    timeline.push({
                        action: 'Pasture assessment',
                        timeframe: '1-2 months',
                        season: 'Autumn',
                        priority: 'medium'
                    });
                }
                
                weedActions.push(
                    'Implement follow-up monitoring program',
                    'Consider biological controls where available'
                );
                
                recs.push({
                    title: 'Weed Management',
                    category: 'vegetation',
                    actions: weedActions,
                    priority: 'high'
                });
                
                timeline.push({
                    action: 'Follow-up weed control',
                    timeframe: '6-12 months',
                    season: 'Depends on species',
                    priority: 'high'
                });
            }
            
            // Erosion control
            if (formData.problems.erosion.present) {
                const severity = formData.problems.erosion.severity;
                const erosionActions = [];
                
                erosionActions.push('Identify erosion hotspots on your map');
                
                if (severity === 'high') {
                    erosionActions.push(
                        'Consult with NRM officer about erosion control structures',
                        'Prioritize areas with greatest erosion risk'
                    );
                    timeline.push({
                        action: 'Erosion control works',
                        timeframe: 'Immediate',
                        season: 'Dry season',
                        priority: 'high'
                    });
                } else {
                    erosionActions.push(
                        'Revegetate with deep-rooted native species',
                        'Minimize ground disturbance in vulnerable areas'
                    );
                    timeline.push({
                        action: 'Erosion control planting',
                        timeframe: '3-6 months',
                        season: 'Winter/Spring',
                        priority: severity === 'medium' ? 'high' : 'medium'
                    });
                }
                
                recs.push({
                    title: 'Erosion Control',
                    category: 'soil',
                    actions: erosionActions,
                    priority: severity === 'high' ? 'high' : 'medium'
                });
            }
            
            // Habitat restoration
            if (formData.problems.habitatLoss.present || formData.problems.goals.includes('Improve biodiversity')) {
                recs.push({
                    title: 'Habitat Restoration',
                    category: 'biodiversity',
                    actions: [
                        'Plant locally native vegetation to create wildlife corridors',
                        formData.property.features.includes('Creeks or rivers') 
                            ? 'Establish riparian buffers along waterways' 
                            : 'Identify areas for habitat restoration on your map',
                        'Consider fencing to protect sensitive areas from stock',
                        'Install nest boxes for hollow-dependent species'
                    ],
                    priority: 'medium'
                });
                
                timeline.push({
                    action: 'Habitat restoration planting',
                    timeframe: '6-12 months',
                    season: 'Winter/Spring',
                    priority: 'medium'
                });
            }
            
            // Fire management
            if (formData.problems.fireRisk.present) {
                recs.push({
                    title: 'Fire Risk Reduction',
                    category: 'fire',
                    actions: [
                        'Create asset protection zones around buildings',
                        'Implement fuel reduction program',
                        'Consider fire access trails',
                        'Develop fire management plan'
                    ],
                    priority: 'high'
                });
                
                timeline.push({
                    action: 'Fire preparedness works',
                    timeframe: 'Before fire season',
                    season: 'Spring',
                    priority: 'high'
                });
            }
            
            // Water quality
            if (formData.problems.waterQuality.present || formData.property.features.includes('Creeks or rivers')) {
                recs.push({
                    title: 'Waterway Management',
                    category: 'water',
                    actions: [
                        'Fence off waterways from stock if possible',
                        'Establish riparian vegetation buffers',
                        'Monitor water quality indicators',
                        'Control erosion in catchment areas'
                    ],
                    priority: 'medium'
                });
                
                timeline.push({
                    action: 'Waterway protection works',
                    timeframe: '6-12 months',
                    season: 'When water levels are low',
                    priority: 'medium'
                });
            }
            
            // Update state with the new arrays
            setFormData(prev => ({
                ...prev,
                recommendations: recs,
                timeline: timeline
            }));
        };

        useEffect(() => {
            if (currentStep === 4) { // Recommendations step
                generateRecommendations();
            }
        }, [currentStep]);

        const renderStep = () => {
            switch(currentStep) {
                case 0:
                    return <WelcomeScreen nextStep={nextStep} />;
                case 1:
                    return <PropertyForm 
                        data={formData.property} 
                        update={(data) => updateFormData('property', data)} 
                        features={propertyFeatures}
                        sampleWeeds={sampleWeeds}
                    />;
                case 2:
                    return <ProblemForm 
                        data={formData.problems} 
                        update={(data) => updateFormData('problems', data)} 
                        sampleWeeds={sampleWeeds}
                        goals={managementGoals}
                        state={formData.property.state}
                    />;
                case 3:
                    return <MapTool 
                        zones={formData.mapZones} 
                        addZone={addMapZone}
                        updateZone={updateZone}
                        removeZone={removeZone}
                        propertyName={formData.property.name}
                        location={formData.property.location}
                        coordinates={formData.property.coordinates}
                        photos={formData.photos}
                        addPhoto={addPhoto}
                        removePhoto={removePhoto}
                    />;
                case 4:
                    return <Recommendations 
                        recommendations={formData.recommendations} 
                        problems={formData.problems}
                    />;
                case 5:
                    return <Timeline 
                        timeline={formData.timeline} 
                        recommendations={formData.recommendations}
                    />;
                case 6:
                    return <ExportPanel formData={formData} />;
                default:
                    return <WelcomeScreen nextStep={nextStep} />;
            }
        };

        return (
            <div className="min-h-screen flex flex-col">
                <header className="bg-green-700 text-white p-4 shadow-md">
                    <div className="container mx-auto flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-bold">LEAP</h1>
                            <p className="text-sm">Landholder Environmental Action Planner</p>
                        </div>
                        <div className="text-sm">
                            {formData.property.name && `Property: ${formData.property.name}`}
                        </div>
                    </div>
                </header>
                
                <div className="container mx-auto p-4 flex-grow">
                    {/* Progress indicator */}
                    <div className="mb-8">
                        <div className="flex justify-between mb-2">
                            {steps.map((step, index) => (
                                <div 
                                    key={index}
                                    className={`text-sm text-center ${currentStep >= index ? 'font-bold text-green-700' : 'text-gray-500'}`}
                                    style={{ width: `${100/steps.length}%` }}
                                >
                                    <div className="text-lg mb-1">{step.icon}</div>
                                    <div>{step.title}</div>
                                </div>
                            ))}
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div 
                                className="bg-green-600 h-2.5 rounded-full" 
                                style={{ width: `${(currentStep / (steps.length - 1)) * 100}%` }}
                            ></div>
                        </div>
                    </div>
                    
                    {/* Main content */}
                    <ErrorBoundary>
                        {renderStep()}
                    </ErrorBoundary>
                </div>
                
                <footer className="bg-gray-100 p-4 border-t">
                    <div className="container mx-auto flex justify-between items-center">
                        <button 
                            onClick={prevStep}
                            disabled={currentStep === 0}
                            className={`px-4 py-2 rounded flex items-center ${currentStep === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-gray-300 hover:bg-gray-400'}`}
                        >
                            ← Back
                        </button>
                        <div className="text-sm text-gray-600">
                            Step {currentStep + 1} of {steps.length}
                        </div>
                        <button 
                            onClick={nextStep}
                            className={`px-4 py-2 rounded flex items-center ${currentStep === steps.length - 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                        >
                            {currentStep === steps.length - 1 ? 'Finish' : 'Next →'}
                        </button>
                    </div>
                </footer>
            </div>
        );
    }

    // Welcome Screen Component
    function WelcomeScreen({ nextStep }) {
        return (
            <div className="text-center py-8">
                <div className="max-w-3xl mx-auto">
                    <h2 className="text-3xl font-bold mb-6 text-green-800">Welcome to LEAP</h2>
                    <p className="mb-6 text-lg">The Landholder Environmental Action Planner helps you create a customized plan for sustainable land management.</p>
                    
                    <div className="grid md:grid-cols-3 gap-6 mb-10">
                        <div className="bg-white p-6 rounded-lg shadow-md border border-green-100">
                            <div className="text-4xl mb-3">🏞️</div>
                            <h3 className="font-bold mb-2">Property Assessment</h3>
                            <p className="text-sm">Document your property's features and identify environmental priorities.</p>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md border border-green-100">
                            <div className="text-4xl mb-3">🗺️</div>
                            <h3 className="font-bold mb-2">Interactive Mapping</h3>
                            <p className="text-sm">Mark areas needing attention directly on your property map.</p>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md border border-green-100">
                            <div className="text-4xl mb-3">📋</div>
                            <h3 className="font-bold mb-2">Action Plan</h3>
                            <p className="text-sm">Get customized recommendations and create a timeline for implementation.</p>
                        </div>
                    </div>
                    
                    <div className="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mb-8 border border-green-200">
                        <h3 className="font-bold mb-4 text-green-700">Ready to begin?</h3>
                        <p className="mb-4">This tool will guide you through creating your environmental action plan in 7 simple steps.</p>
                        <p className="text-sm text-gray-600">You can save your progress at any time and return later.</p>
                    </div>
                    
                    <button 
                        onClick={nextStep}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg shadow-md transition duration-200 transform hover:scale-105"
                    >
                        Start Planning →
                    </button>
                </div>
            </div>
        );
    }

    // Property Form Component
    function PropertyForm({ data, update, features, sampleWeeds }) {
        const [localData, setLocalData] = useState(data);
        const [showWeedPreview, setShowWeedPreview] = useState(false);
        const [searchQuery, setSearchQuery] = useState('');
        const [searchResults, setSearchResults] = useState([]);
        const [isSearching, setIsSearching] = useState(false);
        const searchTimeoutRef = useRef(null);

        const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            setLocalData(prev => ({
                ...prev,
                [name]: type === 'checkbox' ? checked : value
            }));
        };

        const handleFeatureToggle = (feature) => {
            setLocalData(prev => {
                const newFeatures = prev.features.includes(feature)
                    ? prev.features.filter(f => f !== feature)
                    : [...prev.features, feature];
                return { ...prev, features: newFeatures };
            });
        };

        const handleLocationSearch = async () => {
            if (!searchQuery.trim()) return;
            
            setIsSearching(true);
            try {
                const provider = new window.GeoSearch.OpenStreetMapProvider();
                const results = await provider.search({ query: searchQuery });
                setSearchResults(results);
            } catch (error) {
                console.error("Location search error:", error);
                alert("Error searching for location. Please try again.");
            } finally {
                setIsSearching(false);
            }
        };

        const selectLocation = (result) => {
            setLocalData(prev => ({
                ...prev,
                location: result.label,
                coordinates: {
                    lat: result.y,
                    lng: result.x
                }
            }));
            setSearchQuery(result.label);
            setSearchResults([]);
        };

        const useCurrentLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setLocalData(prev => ({
                            ...prev,
                            coordinates: { lat: latitude, lng: longitude }
                        }));
                        
                        // Reverse geocode to get address
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                            .then(response => response.json())
                            .then(data => {
                                const address = data.display_name || 'Current Location';
                                setLocalData(prev => ({
                                    ...prev,
                                    location: address
                                }));
                                setSearchQuery(address);
                            })
                            .catch(error => {
                                console.error("Reverse geocoding error:", error);
                                setLocalData(prev => ({
                                    ...prev,
                                    location: 'Current Location'
                                }));
                                setSearchQuery('Current Location');
                            });
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        alert("Could not retrieve your location. Please ensure location services are enabled.");
                    }
                );
            } else {
                alert("Geolocation is not supported by your browser.");
            }
        };

        useEffect(() => {
            update(localData);
        }, [localData]);

        useEffect(() => {
            if (searchTimeoutRef.current) {
                clearTimeout(searchTimeoutRef.current);
            }
            
            if (searchQuery.trim()) {
                searchTimeoutRef.current = setTimeout(() => {
                    handleLocationSearch();
                }, 500);
            } else {
                setSearchResults([]);
            }
            
            return () => {
                if (searchTimeoutRef.current) {
                    clearTimeout(searchTimeoutRef.current);
                }
            };
        }, [searchQuery]);

        return (
            <div className="max-w-4xl mx-auto">
                <h2 className="text-2xl font-bold mb-6 text-green-800">Tell us about your property</h2>
                
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div className="mb-6">
                        <label className="block text-sm font-medium mb-1 text-gray-700">
                            Property name <span className="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            name="name"
                            value={localData.name}
                            onChange={handleChange}
                            className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            placeholder="e.g., Riverbend Farm"
                            required
                        />
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Property size (hectares)
                            </label>
                            <input
                                type="number"
                                name="size"
                                value={localData.size}
                                onChange={handleChange}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="e.g., 50"
                                min="0"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Nearest town
                            </label>
                            <div className="relative">
                                <input
                                    type="text"
                                    value={searchQuery || localData.location}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="e.g., Bega, NSW"
                                />
                                <button
                                    onClick={useCurrentLocation}
                                    className="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gray-200 hover:bg-gray-300 p-1 rounded"
                                    title="Use my current location"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            {searchResults.length > 0 && (
                                <div className="mt-1 border border-gray-200 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto">
                                    {searchResults.map((result, index) => (
                                        <div 
                                            key={index}
                                            className="p-2 hover:bg-gray-100 cursor-pointer"
                                            onClick={() => selectLocation(result)}
                                        >
                                            <div className="text-sm font-medium">{result.label}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                State/Territory
                            </label>
                            <select
                                name="state"
                                value={localData.state}
                                onChange={handleChange}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            >
                                <option value="">Select...</option>
                                <option value="NSW">New South Wales</option>
                                <option value="VIC">Victoria</option>
                                <option value="QLD">Queensland</option>
                                <option value="WA">Western Australia</option>
                                <option value="SA">South Australia</option>
                                <option value="TAS">Tasmania</option>
                                <option value="NT">Northern Territory</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Average annual rainfall (mm)
                            </label>
                            <select
                                name="rainfall"
                                value={localData.rainfall}
                                onChange={handleChange}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            >
                                <option value="">Select...</option>
                                <option value="<250">Less than 250mm</option>
                                <option value="250-500">250-500mm</option>
                                <option value="500-750">500-750mm</option>
                                <option value="750-1000">750-1000mm</option>
                                <option value=">1000">More than 1000mm</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Dominant soil type
                            </label>
                            <select
                                name="soilType"
                                value={localData.soilType}
                                onChange={handleChange}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            >
                                <option value="">Select...</option>
                                <option value="clay">Clay</option>
                                <option value="sandy">Sandy</option>
                                <option value="loam">Loam</option>
                                <option value="rocky">Rocky</option>
                                <option value="volcanic">Volcanic</option>
                                <option value="alluvial">Alluvial</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <label className="block text-sm font-medium mb-2 text-gray-700">
                            What features does your property have? <span className="help-tooltip" title="Select all that apply">(?)</span>
                        </label>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {features.map(feature => (
                                <div key={feature} className="flex items-start">
                                    <div className="flex items-center h-5">
                                        <input
                                            type="checkbox"
                                            id={`feature-${feature}`}
                                            checked={localData.features.includes(feature)}
                                            onChange={() => handleFeatureToggle(feature)}
                                            className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                        />
                                    </div>
                                    <label htmlFor={`feature-${feature}`} className="ml-2 block text-sm text-gray-700">
                                        {feature}
                                    </label>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {localData.state && (
                        <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <div className="flex justify-between items-center">
                                <h3 className="font-medium text-blue-800">
                                    Common weeds in {localData.state}:
                                </h3>
                                <button 
                                    onClick={() => setShowWeedPreview(!showWeedPreview)}
                                    className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                >
                                    {showWeedPreview ? 'Hide' : 'Show'}
                                </button>
                            </div>
                            {showWeedPreview && (
                                <div className="mt-2">
                                    <p className="text-sm text-gray-600 mb-2">These may help when identifying problems in the next step:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {sampleWeeds[localData.state]?.map(weed => (
                                            <span key={weed} className="bg-white px-2 py-1 rounded text-sm border">
                                                {weed}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // Problem Form Component
    function ProblemForm({ data, update, sampleWeeds, goals, state }) {
        const [localData, setLocalData] = useState(data);
        const [otherWeed, setOtherWeed] = useState('');
        const [otherGoal, setOtherGoal] = useState('');

        const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            
            if (name.includes('.')) {
                // Handle nested properties (e.g., erosion.present)
                const [parent, child] = name.split('.');
                setLocalData(prev => ({
                    ...prev,
                    [parent]: {
                        ...prev[parent],
                        [child]: type === 'checkbox' ? checked : value
                    }
                }));
            } else {
                setLocalData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            }
        };

        const handleWeedToggle = (weed) => {
            setLocalData(prev => {
                let newWeeds;
                if (weed === 'Other (please specify)') {
                    // Handle other weed specially
                    newWeeds = prev.weeds.includes(weed)
                        ? prev.weeds.filter(w => w !== weed && w !== otherWeed)
                        : [...prev.weeds, weed];
                } else {
                    newWeeds = prev.weeds.includes(weed)
                        ? prev.weeds.filter(w => w !== weed)
                        : [...prev.weeds, weed];
                }
                return { ...prev, weeds: newWeeds };
            });
        };

        const addOtherWeed = () => {
            if (otherWeed.trim() && !localData.weeds.includes(otherWeed)) {
                setLocalData(prev => ({
                    ...prev,
                    weeds: [...prev.weeds.filter(w => w !== 'Other (please specify)'), otherWeed]
                }));
                setOtherWeed('');
            }
        };

        const handleGoalToggle = (goal) => {
            setLocalData(prev => {
                let newGoals;
                if (goal === 'Other (please specify)') {
                    // Handle other goal specially
                    newGoals = prev.goals.includes(goal)
                        ? prev.goals.filter(g => g !== goal && g !== otherGoal)
                        : [...prev.goals, goal];
                } else {
                    newGoals = prev.goals.includes(goal)
                        ? prev.goals.filter(g => g !== goal)
                        : [...prev.goals, goal];
                }
                return { ...prev, goals: newGoals };
            });
        };

        const addOtherGoal = () => {
            if (otherGoal.trim() && !localData.goals.includes(otherGoal)) {
                setLocalData(prev => ({
                    ...prev,
                    goals: [...prev.goals.filter(g => g !== 'Other (please specify)'), otherGoal]
                }));
                setOtherGoal('');
            }
        };

        useEffect(() => {
            update(localData);
        }, [localData]);

        return (
            <div className="max-w-4xl mx-auto">
                <h2 className="text-2xl font-bold mb-6 text-green-800">Identify your property's environmental priorities</h2>
                
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-8">
                    <div>
                        <h3 className="text-lg font-medium mb-4 text-gray-800">Environmental Issues</h3>
                        <div className="space-y-6">
                            {[
                                { 
                                    id: 'erosion', 
                                    label: 'Soil erosion',
                                    description: 'Loss of topsoil through water or wind action'
                                },
                                { 
                                    id: 'habitatLoss', 
                                    label: 'Habitat loss or degradation',
                                    description: 'Decline in native vegetation or wildlife habitat'
                                },
                                { 
                                    id: 'waterQuality', 
                                    label: 'Water quality concerns',
                                    description: 'Issues with turbidity, nutrients, or pollution in water bodies'
                                },
                                { 
                                    id: 'fireRisk', 
                                    label: 'Bushfire risk',
                                    description: 'Areas with high fuel load or near assets'
                                }
                            ].map(issue => (
                                <div key={issue.id} className="border-b pb-4 last:border-b-0">
                                    <div className="flex items-start">
                                        <div className="flex items-center h-5">
                                            <input
                                                type="checkbox"
                                                id={`${issue.id}-present`}
                                                name={`${issue.id}.present`}
                                                checked={localData[issue.id].present}
                                                onChange={handleChange}
                                                className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                            />
                                        </div>
                                        <div className="ml-3 flex-1">
                                            <label htmlFor={`${issue.id}-present`} className="block text-sm font-medium text-gray-700">
                                                {issue.label}
                                            </label>
                                            <p className="text-sm text-gray-500">{issue.description}</p>
                                            
                                            {localData[issue.id].present && (
                                                <div className="mt-2">
                                                    <label className="block text-xs font-medium text-gray-500 mb-1">Severity:</label>
                                                    <div className="flex space-x-4">
                                                        {['low', 'medium', 'high'].map(level => (
                                                            <div key={level} className="flex items-center">
                                                                <input
                                                                    type="radio"
                                                                    id={`${issue.id}-${level}`}
                                                                    name={`${issue.id}.severity`}
                                                                    value={level}
                                                                    checked={localData[issue.id].severity === level}
                                                                    onChange={handleChange}
                                                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300"
                                                                />
                                                                <label htmlFor={`${issue.id}-${level}`} className="ml-2 block text-sm text-gray-700 capitalize">
                                                                    {level}
                                                                </label>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div>
                        <h3 className="text-lg font-medium mb-3 text-gray-800">Weed Problems</h3>
                        <p className="text-sm text-gray-600 mb-4">Select all weed species present on your property:</p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            {sampleWeeds[state]?.map(weed => (
                                <div key={weed} className="flex items-start">
                                    <div className="flex items-center h-5">
                                        <input
                                            type="checkbox"
                                            id={`weed-${weed}`}
                                            checked={localData.weeds.includes(weed)}
                                            onChange={() => handleWeedToggle(weed)}
                                            className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                        />
                                    </div>
                                    <label htmlFor={`weed-${weed}`} className="ml-2 block text-sm text-gray-700">
                                        {weed}
                                    </label>
                                </div>
                            ))}
                            
                            <div className="flex items-start">
                                <div className="flex items-center h-5">
                                    <input
                                        type="checkbox"
                                        id="weed-other"
                                        checked={localData.weeds.includes('Other (please specify)') || 
                                                 localData.weeds.some(w => !sampleWeeds[state]?.includes(w))}
                                        onChange={() => handleWeedToggle('Other (please specify)')}
                                        className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                    />
                                </div>
                                <label htmlFor="weed-other" className="ml-2 block text-sm text-gray-700">
                                    Other (please specify)
                                </label>
                            </div>
                        </div>
                        
                        {(localData.weeds.includes('Other (please specify)') || 
                          localData.weeds.some(w => !sampleWeeds[state]?.includes(w))) && (
                            <div className="flex gap-2 mt-2">
                                <input
                                    type="text"
                                    value={otherWeed}
                                    onChange={(e) => setOtherWeed(e.target.value)}
                                    placeholder="Specify weed species"
                                    className="flex-grow p-2 border rounded-lg text-sm"
                                />
                                <button 
                                    onClick={addOtherWeed}
                                    className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                >
                                    Add
                                </button>
                            </div>
                        )}
                        
                        {localData.weeds.length > 0 && (
                            <div className="mt-3">
                                <p className="text-sm font-medium">Selected weeds:</p>
                                <div className="flex flex-wrap gap-2 mt-1">
                                    {localData.weeds.map(weed => (
                                        <span key={weed} className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                            {weed}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <h3 className="text-lg font-medium mb-3 text-gray-800">Management Goals</h3>
                        <p className="text-sm text-gray-600 mb-4">What are your main objectives for your property?</p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            {goals.map(goal => (
                                <div key={goal} className="flex items-start">
                                    <div className="flex items-center h-5">
                                        <input
                                            type="checkbox"
                                            id={`goal-${goal}`}
                                            checked={localData.goals.includes(goal)}
                                            onChange={() => handleGoalToggle(goal)}
                                            className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                        />
                                    </div>
                                    <label htmlFor={`goal-${goal}`} className="ml-2 block text-sm text-gray-700">
                                        {goal}
                                    </label>
                                </div>
                            ))}
                            
                            <div className="flex items-start">
                                <div className="flex items-center h-5">
                                    <input
                                        type="checkbox"
                                        id="goal-other"
                                        checked={localData.goals.includes('Other (please specify)') || 
                                                 localData.goals.some(g => !goals.includes(g))}
                                        onChange={() => handleGoalToggle('Other (please specify)')}
                                        className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                    />
                                </div>
                                <label htmlFor="goal-other" className="ml-2 block text-sm text-gray-700">
                                    Other (please specify)
                                </label>
                            </div>
                        </div>
                        
                        {(localData.goals.includes('Other (please specify)') || 
                          localData.goals.some(g => !goals.includes(g))) && (
                            <div className="flex gap-2 mt-2">
                                <input
                                    type="text"
                                    value={otherGoal}
                                    onChange={(e) => setOtherGoal(e.target.value)}
                                    placeholder="Specify your goal"
                                    className="flex-grow p-2 border rounded-lg text-sm"
                                />
                                <button 
                                    onClick={addOtherGoal}
                                    className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                >
                                    Add
                                </button>
                            </div>
                        )}
                        
                        {localData.goals.length > 0 && (
                            <div className="mt-3">
                                <p className="text-sm font-medium">Selected goals:</p>
                                <div className="flex flex-wrap gap-2 mt-1">
                                    {localData.goals.map(goal => (
                                        <span key={goal} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                            {goal}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium mb-2 text-gray-700">
                            Any other environmental concerns or notes?
                        </label>
                        <textarea
                            name="otherProblems"
                            value={localData.otherProblems}
                            onChange={handleChange}
                            className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 h-24"
                            placeholder="e.g., feral animals, salinity, drought impacts..."
                        ></textarea>
                    </div>
                </div>
            </div>
        );
    }

    // Map Tool Component
    function MapTool({ zones, addZone, updateZone, removeZone, propertyName, location, coordinates, photos, addPhoto, removePhoto }) {
        const mapRef = useRef(null);
        const mapInstance = useRef(null);
        const drawnItemsRef = useRef(null);
        const drawControlRef = useRef(null);
        const baseLayersRef = useRef({});
        
        const [zoneName, setZoneName] = useState('');
        const [zoneType, setZoneType] = useState('management');
        const [zoneNotes, setZoneNotes] = useState('');
        const [editingZone, setEditingZone] = useState(null);
        const [hasDrawnZone, setHasDrawnZone] = useState(false);
        const drawnLayerRef = useRef(null);
        const [activeLayer, setActiveLayer] = useState('street');
        const [photoNotes, setPhotoNotes] = useState('');
        const fileInputRef = useRef(null);
        
        // Initialize map
        useEffect(() => {
            if (!mapInstance.current && mapRef.current && window.L) {
                // Create map instance
                const map = window.L.map(mapRef.current);
                
                // Add base layers
                const streetLayer = window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                });
                
                const satelliteLayer = window.L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                });
                
                const topographicLayer = window.L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                });
                
                // Add default layer
                streetLayer.addTo(map);
                
                // Store base layers
                baseLayersRef.current = {
                    'Street Map': streetLayer,
                    'Satellite View': satelliteLayer,
                    'Topographic Map': topographicLayer
                };
                
                // Add layer control
                window.L.control.layers(baseLayersRef.current, null, {
                    collapsed: false
                }).addTo(map);
                
                // Initialize the FeatureGroup to store editable layers
                const drawnItems = new window.L.FeatureGroup();
                map.addLayer(drawnItems);
                drawnItemsRef.current = drawnItems;
                
                // Add draw control with all drawing options
                const drawControl = new window.L.Control.Draw({
                    edit: {
                        featureGroup: drawnItems,
                        edit: false
                    },
                    draw: {
                        polygon: {
                            allowIntersection: false,
                            drawError: {
                                color: '#e1e100',
                                message: '<strong>Error:</strong> shape edges cannot cross!'
                            },
                            shapeOptions: {
                                color: '#3388ff',
                                fillOpacity: 0.2
                            },
                            showArea: true,
                            metric: true
                        },
                        polyline: {
                            shapeOptions: {
                                color: '#3388ff',
                                weight: 5
                            },
                            showLength: true,
                            metric: true
                        },
                        rectangle: {
                            shapeOptions: {
                                color: '#3388ff',
                                fillOpacity: 0.2
                            },
                            showArea: true,
                            metric: true
                        },
                        circle: false,
                        marker: {
                            icon: window.L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background-color: #3388ff; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        },
                        circlemarker: false
                    }
                });
                map.addControl(drawControl);
                drawControlRef.current = drawControl;
                
                // Add locate control
                const locateControl = window.L.control.locate({
                    position: 'topright',
                    drawCircle: true,
                    follow: true,
                    setView: 'once',
                    keepCurrentZoomLevel: true,
                    markerStyle: {
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.8
                    },
                    circleStyle: {
                        weight: 1,
                        fillOpacity: 0.1
                    },
                    icon: 'fa fa-location-arrow',
                    metric: true,
                    strings: {
                        title: "Show my location",
                        popup: "You are within {distance} {unit} from this point",
                        outsideMapBoundsMsg: "You seem located outside the boundaries of the map"
                    },
                    locateOptions: {
                        maxZoom: 16,
                        watch: true,
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 10000
                    }
                }).addTo(map);
                
                // Add search control
                const searchControl = new window.GeoSearch.GeoSearchControl({
                    provider: new window.GeoSearch.OpenStreetMapProvider(),
                    style: 'bar',
                    showMarker: true,
                    showPopup: false,
                    marker: {
                        icon: new window.L.Icon.Default(),
                        draggable: false,
                    },
                    popupFormat: ({ query, result }) => result.label,
                    maxMarkers: 1,
                    retainZoomLevel: false,
                    animateZoom: true,
                    autoClose: true,
                    searchLabel: 'Search for location',
                    keepResult: true
                });
                map.addControl(searchControl);
                
                // Set initial view based on property coordinates or default
                if (coordinates && coordinates.lat && coordinates.lng) {
                    map.setView([coordinates.lat, coordinates.lng], 14);
                } else {
                    map.setView([-35.0, 149.0], 10);
                }
                
                // Handle created shapes
                map.on(window.L.Draw.Event.CREATED, (e) => {
                    const layer = e.layer;
                    drawnItems.addLayer(layer);
                    setHasDrawnZone(true);
                    
                    // Store the drawn layer reference
                    drawnLayerRef.current = layer;
                    
                    const colors = {
                        management: '#3388ff',
                        problem: '#ff0000',
                        sensitive: '#33cc33',
                        other: '#ffcc00'
                    };
                    
                    layer.setStyle({
                        color: colors[zoneType] || '#3388ff',
                        fillColor: colors[zoneType] || '#3388ff',
                        fillOpacity: 0.2,
                        weight: 2
                    });
                    
                    // Add label for the zone
                    if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                        const center = e.layer.getBounds().getCenter();
                        const label = window.L.marker(center, {
                            icon: window.L.divIcon({
                                className: 'zone-label',
                                html: `<div class="zone-label-text">${zoneName || 'Zone'}</div>`,
                                iconSize: [100, 20],
                                iconAnchor: [50, 10]
                            }),
                            interactive: false
                        }).addTo(map);
                        layer.label = label;
                    }
                    
                    layer.bindPopup(`<b>${zoneName || 'Unnamed zone'}</b><br>Type: ${zoneType}`);
                });
                
                // Handle layer selection changes
                map.on('baselayerchange', (e) => {
                    setActiveLayer(e.name === 'Street Map' ? 'street' : 
                                   e.name === 'Satellite View' ? 'satellite' : 'topographic');
                });
                
                mapInstance.current = map;
                
                // Expose functions to window for popup buttons
                window.editZone = (index) => {
                    setEditingZone(index);
                    const zone = zones[index];
                    setZoneName(zone.name);
                    setZoneType(zone.type);
                    setZoneNotes(zone.notes || '');
                    setHasDrawnZone(true);
                    
                    drawnItems.eachLayer(layer => {
                        if (layer._leaflet_id === zones[index].coordinates.id) {
                            layer.setStyle({ weight: 4, fillOpacity: 0.3 });
                        } else {
                            layer.setStyle({ weight: 2, fillOpacity: 0.2 });
                        }
                    });
                };
                
                window.deleteZone = (index) => {
                    if (confirm('Are you sure you want to delete this zone?')) {
                        removeZone(index);
                        setHasDrawnZone(zones.length > 1);
                    }
                };
            }
            
            return () => {
                // Cleanup function
                if (mapInstance.current) {
                    mapInstance.current.off();
                    mapInstance.current.remove();
                    mapInstance.current = null;
                }
                
                // Cleanup window functions
                window.editZone = undefined;
                window.deleteZone = undefined;
            };
        }, []);
        
        // Add existing zones to map
        useEffect(() => {
            if (mapInstance.current && drawnItemsRef.current) {
                drawnItemsRef.current.clearLayers();
                
                zones.forEach((zone, index) => {
                    let layer;
                    if (zone.coordinates.type === 'Point') {
                        layer = window.L.marker(
                            [zone.coordinates.coordinates[1], zone.coordinates.coordinates[0]],
                            {
                                icon: window.L.divIcon({
                                    className: 'custom-marker',
                                    html: `<div style="background-color: ${getZoneColor(zone.type)}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }
                        );
                    } else {
                        // Convert GeoJSON to Leaflet layer
                        const geoJsonLayer = window.L.geoJSON(zone.coordinates);
                        // Get the first layer (since geoJSON might have multiple)
                        layer = geoJsonLayer.getLayers()[0];
                    }
                    
                    if (layer) {
                        layer.setStyle({
                            color: getZoneColor(zone.type),
                            fillColor: getZoneColor(zone.type),
                            fillOpacity: 0.2,
                            weight: 2
                        });
                        
                        // Add label for polygons/rectangles
                        if (zone.coordinates.type === 'Polygon' || zone.coordinates.type === 'MultiPolygon') {
                            const coords = zone.coordinates.type === 'Polygon' ? 
                                zone.coordinates.coordinates[0] : zone.coordinates.coordinates[0][0];
                            const center = window.L.latLngBounds(
                                coords.map(coord => window.L.latLng(coord[1], coord[0]))
                            ).getCenter();
                            
                            const label = window.L.marker(center, {
                                icon: window.L.divIcon({
                                    className: 'zone-label',
                                    html: `<div class="zone-label-text">${zone.name || 'Zone'}</div>`,
                                    iconSize: [100, 20],
                                    iconAnchor: [50, 10]
                                }),
                                interactive: false
                            }).addTo(mapInstance.current);
                            layer.label = label;
                        }
                        
                        layer.bindPopup(`
                            <b>${zone.name}</b><br>
                            Type: ${zone.type}<br>
                            ${zone.notes ? `Notes: ${zone.notes}` : ''}
                            <div class="mt-2">
                                <button onclick="window.editZone(${index})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">
                                    Edit
                                </button>
                                <button onclick="window.deleteZone(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-xs ml-1">
                                    Delete
                                </button>
                            </div>
                        `);
                        
                        drawnItemsRef.current.addLayer(layer);
                    }
                });
                
                if (zones.length > 0 && mapInstance.current) {
                    mapInstance.current.fitBounds(drawnItemsRef.current.getBounds());
                    setHasDrawnZone(true);
                }
            }
        }, [zones]);
        
        const getZoneColor = (type) => {
            const colors = {
                management: '#3388ff',
                problem: '#ff0000',
                sensitive: '#33cc33',
                other: '#ffcc00'
            };
            return colors[type] || '#3388ff';
        };
        
        const saveZone = () => {
            if (!zoneName) {
                alert('Please provide a zone name');
                return;
            }
            
            if (!hasDrawnZone && editingZone === null) {
                alert('Please draw a zone on the map first');
                return;
            }
            
            if (editingZone !== null) {
                // Update existing zone
                const updatedZone = {
                    name: zoneName,
                    type: zoneType,
                    notes: zoneNotes,
                    coordinates: zones[editingZone].coordinates
                };
                updateZone(editingZone, updatedZone);
                setEditingZone(null);
            } else {
                // Add new zone
                if (drawnLayerRef.current && drawnLayerRef.current.toGeoJSON) {
                    const geoJson = drawnLayerRef.current.toGeoJSON();
                    // Ensure we have a valid geometry
                    if (geoJson.geometry && geoJson.geometry.coordinates) {
                        const zone = {
                            name: zoneName,
                            type: zoneType,
                            notes: zoneNotes,
                            coordinates: geoJson.geometry
                        };
                        addZone(zone);
                    } else {
                        alert('Please draw a valid zone on the map first');
                        return;
                    }
                } else {
                    alert('Please draw a zone on the map first');
                    return;
                }
            }
            
            // Reset form
            setZoneName('');
            setZoneType('management');
            setZoneNotes('');
            setHasDrawnZone(false);
            drawnLayerRef.current = null;
        };
        
        const cancelEdit = () => {
            setEditingZone(null);
            setZoneName('');
            setZoneType('management');
            setZoneNotes('');
            setHasDrawnZone(zones.length > 0);
            
            if (drawnItemsRef.current) {
                drawnItemsRef.current.eachLayer(layer => {
                    layer.setStyle({ weight: 2, fillOpacity: 0.2 });
                });
            }
        };
        
        const handleFileChange = (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        addPhoto({
                            url: event.target.result,
                            notes: photoNotes,
                            date: new Date().toISOString()
                        });
                    };
                    reader.readAsDataURL(file);
                });
                setPhotoNotes('');
                e.target.value = ''; // Reset file input
            }
        };
        
        const triggerFileInput = () => {
            fileInputRef.current.click();
        };
        
        const takePhoto = () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Try to get the back camera first
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' } // Prefer back camera
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        // Create video element to show camera feed
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.play();
                        
                        // Create a container for the camera interface
                        const cameraContainer = document.createElement('div');
                        cameraContainer.style.position = 'fixed';
                        cameraContainer.style.top = '0';
                        cameraContainer.style.left = '0';
                        cameraContainer.style.width = '100%';
                        cameraContainer.style.height = '100%';
                        cameraContainer.style.backgroundColor = 'rgba(0,0,0,0.8)';
                        cameraContainer.style.zIndex = '1000';
                        cameraContainer.style.display = 'flex';
                        cameraContainer.style.flexDirection = 'column';
                        cameraContainer.style.alignItems = 'center';
                        cameraContainer.style.justifyContent = 'center';
                        
                        // Add video to container
                        video.style.maxWidth = '100%';
                        video.style.maxHeight = '70vh';
                        cameraContainer.appendChild(video);
                        
                        // Add capture button
                        const captureBtn = document.createElement('button');
                        captureBtn.textContent = 'Take Photo';
                        captureBtn.style.marginTop = '20px';
                        captureBtn.style.padding = '10px 20px';
                        captureBtn.style.backgroundColor = '#4CAF50';
                        captureBtn.style.color = 'white';
                        captureBtn.style.border = 'none';
                        captureBtn.style.borderRadius = '5px';
                        captureBtn.style.cursor = 'pointer';
                        
                        captureBtn.addEventListener('click', () => {
                            // Create canvas to capture photo
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            
                            // Convert to data URL and add as photo
                            const photoData = canvas.toDataURL('image/jpeg');
                            addPhoto({
                                url: photoData,
                                notes: photoNotes,
                                date: new Date().toISOString()
                            });
                            
                            // Clean up
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(cameraContainer);
                            setPhotoNotes('');
                        });
                        
                        // Add cancel button
                        const cancelBtn = document.createElement('button');
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.style.marginTop = '10px';
                        cancelBtn.style.padding = '10px 20px';
                        cancelBtn.style.backgroundColor = '#f44336';
                        cancelBtn.style.color = 'white';
                        cancelBtn.style.border = 'none';
                        cancelBtn.style.borderRadius = '5px';
                        cancelBtn.style.cursor = 'pointer';
                        
                        cancelBtn.addEventListener('click', () => {
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(cameraContainer);
                        });
                        
                        // Add buttons to container
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.display = 'flex';
                        buttonContainer.style.gap = '10px';
                        buttonContainer.appendChild(captureBtn);
                        buttonContainer.appendChild(cancelBtn);
                        cameraContainer.appendChild(buttonContainer);
                        
                        // Add container to body
                        document.body.appendChild(cameraContainer);
                    })
                    .catch(error => {
                        console.error("Camera error:", error);
                        // If back camera fails, try any camera
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                // Same camera interface code as above
                                const video = document.createElement('video');
                                video.srcObject = stream;
                                video.play();
                                
                                const cameraContainer = document.createElement('div');
                                cameraContainer.style.position = 'fixed';
                                cameraContainer.style.top = '0';
                                cameraContainer.style.left = '0';
                                cameraContainer.style.width = '100%';
                                cameraContainer.style.height = '100%';
                                cameraContainer.style.backgroundColor = 'rgba(0,0,0,0.8)';
                                cameraContainer.style.zIndex = '1000';
                                cameraContainer.style.display = 'flex';
                                cameraContainer.style.flexDirection = 'column';
                                cameraContainer.style.alignItems = 'center';
                                cameraContainer.style.justifyContent = 'center';
                                
                                video.style.maxWidth = '100%';
                                video.style.maxHeight = '70vh';
                                cameraContainer.appendChild(video);
                                
                                const captureBtn = document.createElement('button');
                                captureBtn.textContent = 'Take Photo';
                                captureBtn.style.marginTop = '20px';
                                captureBtn.style.padding = '10px 20px';
                                captureBtn.style.backgroundColor = '#4CAF50';
                                captureBtn.style.color = 'white';
                                captureBtn.style.border = 'none';
                                captureBtn.style.borderRadius = '5px';
                                captureBtn.style.cursor = 'pointer';
                                
                                captureBtn.addEventListener('click', () => {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = video.videoWidth;
                                    canvas.height = video.videoHeight;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                    
                                    const photoData = canvas.toDataURL('image/jpeg');
                                    addPhoto({
                                        url: photoData,
                                        notes: photoNotes,
                                        date: new Date().toISOString()
                                    });
                                    
                                    stream.getTracks().forEach(track => track.stop());
                                    document.body.removeChild(cameraContainer);
                                    setPhotoNotes('');
                                });
                                
                                const cancelBtn = document.createElement('button');
                                cancelBtn.textContent = 'Cancel';
                                cancelBtn.style.marginTop = '10px';
                                cancelBtn.style.padding = '10px 20px';
                                cancelBtn.style.backgroundColor = '#f44336';
                                cancelBtn.style.color = 'white';
                                cancelBtn.style.border = 'none';
                                cancelBtn.style.borderRadius = '5px';
                                cancelBtn.style.cursor = 'pointer';
                                
                                cancelBtn.addEventListener('click', () => {
                                    stream.getTracks().forEach(track => track.stop());
                                    document.body.removeChild(cameraContainer);
                                });
                                
                                const buttonContainer = document.createElement('div');
                                buttonContainer.style.display = 'flex';
                                buttonContainer.style.gap = '10px';
                                buttonContainer.appendChild(captureBtn);
                                buttonContainer.appendChild(cancelBtn);
                                cameraContainer.appendChild(buttonContainer);
                                
                                document.body.appendChild(cameraContainer);
                            })
                            .catch(error => {
                                console.error("Camera error:", error);
                                alert("Could not access camera. Please ensure camera permissions are granted.");
                            });
                    });
            } else {
                alert("Camera access is not supported by your browser or device.");
            }
        };
        
        return (
            <div className="max-w-6xl mx-auto">
                <h2 className="text-2xl font-bold mb-6 text-green-800">Map your property zones</h2>
                
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <p className="mb-6">Draw areas on the map to identify different zones (e.g., weed areas, sensitive ecosystems, planned works). Click on zones to edit or delete them.</p>
                    
                    <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Zone name <span className="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                value={zoneName}
                                onChange={(e) => setZoneName(e.target.value)}
                                className="w-full p-2 border rounded-lg"
                                placeholder="e.g., North paddock weeds"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Zone type
                            </label>
                            <select
                                value={zoneType}
                                onChange={(e) => setZoneType(e.target.value)}
                                className="w-full p-2 border rounded-lg"
                            >
                                <option value="management">Management area</option>
                                <option value="problem">Problem area</option>
                                <option value="sensitive">Sensitive area</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Notes (optional)
                            </label>
                            <input
                                type="text"
                                value={zoneNotes}
                                onChange={(e) => setZoneNotes(e.target.value)}
                                className="w-full p-2 border rounded-lg"
                                placeholder="e.g., High priority area"
                            />
                        </div>
                        <div className="flex items-end space-x-2">
                            <button
                                onClick={saveZone}
                                disabled={!zoneName || (!hasDrawnZone && editingZone === null)}
                                className={`px-4 py-2 rounded-lg flex-1 ${(!zoneName || (!hasDrawnZone && editingZone === null)) ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                            >
                                {editingZone !== null ? 'Update Zone' : 'Save Zone'}
                            </button>
                            {editingZone !== null && (
                                <button
                                    onClick={cancelEdit}
                                    className="px-3 py-2 rounded-lg bg-gray-300 hover:bg-gray-400"
                                >
                                    Cancel
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div ref={mapRef} id="map" className="mb-6 rounded-lg overflow-hidden border border-gray-300"></div>
                    
                    <div className="mb-6">
                        <h3 className="font-medium mb-3 text-gray-800">Site Photos</h3>
                        <div className="flex flex-wrap gap-4 mb-4">
                            {photos.map((photo, index) => (
                                <div key={index} className="relative group">
                                    <img 
                                        src={photo.url} 
                                        alt={`Site photo ${index + 1}`} 
                                        className="w-32 h-32 object-cover rounded-lg border border-gray-300"
                                    />
                                    <button
                                        onClick={() => removePhoto(index)}
                                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        ×
                                    </button>
                                    {photo.notes && (
                                        <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate">
                                            {photo.notes}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        <div className="flex flex-col sm:flex-row gap-2">
                            <input
                                type="text"
                                value={photoNotes}
                                onChange={(e) => setPhotoNotes(e.target.value)}
                                placeholder="Photo description (optional)"
                                className="flex-grow p-2 border rounded-lg"
                            />
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleFileChange}
                                accept="image/*"
                                multiple
                                className="hidden"
                            />
                            <button
                                onClick={triggerFileInput}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                            >
                                Upload Photos
                            </button>
                            <button
                                onClick={takePhoto}
                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                            >
                                Take Photo
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 className="font-medium mb-3 text-gray-800">Your saved zones:</h3>
                        {zones.length === 0 ? (
                            <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No zones saved yet. Draw on the map, fill in details above, and click "Save Zone".</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shape</th>
                                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {zones.map((zone, index) => (
                                            <tr key={index} className={`${zone.type === 'management' ? 'bg-blue-50' : 
                                                                       zone.type === 'problem' ? 'bg-red-50' : 
                                                                       zone.type === 'sensitive' ? 'bg-green-50' : 'bg-yellow-50'}`}>
                                                <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{zone.name}</td>
                                                <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 capitalize">{zone.type}</td>
                                                <td className="px-4 py-3 text-sm text-gray-500">{zone.notes || '-'}</td>
                                                <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                    {zone.coordinates.type === 'Point' ? 'Marker' : 
                                                     zone.coordinates.type === 'LineString' ? 'Line' : 
                                                     zone.coordinates.type === 'Polygon' ? 'Polygon' : 
                                                     zone.coordinates.type === 'MultiPolygon' ? 'Polygon' : 
                                                     zone.coordinates.type}
                                                </td>
                                                <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                                    <button 
                                                        onClick={() => {
                                                            setEditingZone(index);
                                                            const zone = zones[index];
                                                            setZoneName(zone.name);
                                                            setZoneType(zone.type);
                                                            setZoneNotes(zone.notes || '');
                                                            setHasDrawnZone(true);
                                                        }}
                                                        className="text-blue-600 hover:text-blue-900 mr-3"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button 
                                                        onClick={() => {
                                                            if (confirm('Are you sure you want to delete this zone?')) {
                                                                removeZone(index);
                                                                setHasDrawnZone(zones.length > 1);
                                                            }
                                                        }}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // Recommendations Component
    function Recommendations({ recommendations = [], problems }) {
        const priorityOrder = { high: 1, medium: 2, low: 3 };
        
        // Ensure recommendations is always an array
        const safeRecommendations = Array.isArray(recommendations) ? recommendations : [];
        
        const sortedRecs = [...safeRecommendations].sort((a, b) => 
            priorityOrder[a.priority] - priorityOrder[b.priority]
        );
        
        return (
            <div className="max-w-4xl mx-auto">
                <h2 className="text-2xl font-bold mb-6 text-green-800">Your Custom Recommendations</h2>
                
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    {safeRecommendations.length === 0 ? (
                        <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No recommendations generated. Please go back and provide more information about your property.</p>
                    ) : (
                        <div className="space-y-6">
                            {sortedRecs.map((rec, index) => (
                                <div key={index} className="border-l-4 border-green-500 pl-4 py-3 bg-gray-50 rounded-r-lg">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-lg mb-2 text-green-800">{rec.title}</h3>
                                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                                            rec.priority === 'high' ? 'bg-red-100 text-red-800' :
                                            rec.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }`}>
                                            {rec.priority} priority
                                        </span>
                                    </div>
                                    <ul className="list-disc list-inside space-y-2 pl-2">
                                        {Array.isArray(rec.actions) && rec.actions.map((action, i) => (
                                            <li key={i} className="text-gray-700">{action}</li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // Timeline Component
    function Timeline({ timeline = [], recommendations }) {
        const now = new Date();
        const currentMonth = now.getMonth();
        
        const getSeason = (month) => {
            if (month >= 11 || month <= 1) return 'Summer';
            if (month >= 2 && month <= 4) return 'Autumn';
            if (month >= 5 && month <= 7) return 'Winter';
            return 'Spring';
        };
        
        const currentSeason = getSeason(currentMonth);
        
        // Ensure timeline is always an array
        const safeTimeline = Array.isArray(timeline) ? timeline : [];
        
        const timeGroups = {
            immediate: safeTimeline.filter(item => item.timeframe === 'Immediate'),
            '1-3 months': safeTimeline.filter(item => item.timeframe === '1-3 months'),
            '3-6 months': safeTimeline.filter(item => item.timeframe === '3-6 months'),
            '6-12 months': safeTimeline.filter(item => item.timeframe === '6-12 months'),
            '12+ months': safeTimeline.filter(item => item.timeframe.includes('12'))
        };
        
        return (
            <div className="max-w-4xl mx-auto">
                <h2 className="text-2xl font-bold mb-6 text-green-800">Action Timeline</h2>
                
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div className="mb-6">
                        <h3 className="text-lg font-medium mb-3 text-gray-800">Current Season: {currentSeason}</h3>
                        <p className="text-sm text-gray-600">The timeline below suggests when to implement actions based on seasonal considerations.</p>
                    </div>
                    
                    {safeTimeline.length === 0 ? (
                        <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No timeline generated. Please go back and provide more information about your property.</p>
                    ) : (
                        <div className="space-y-8">
                            {Object.entries(timeGroups).map(([timeframe, items]) => (
                                items.length > 0 && (
                                    <div key={timeframe}>
                                        <h4 className="font-bold text-md mb-3 border-b pb-2 text-gray-700">
                                            {timeframe === 'immediate' ? 'Immediate Actions' : `Within ${timeframe}`}
                                        </h4>
                                        <div className="space-y-3">
                                            {items.map((item, index) => (
                                                <div key={index} className="flex items-start p-3 rounded-lg border border-gray-200 hover:bg-gray-50">
                                                    <div className={`flex-shrink-0 h-5 w-5 rounded-full mt-1 ${
                                                        item.priority === 'high' ? 'bg-red-500' :
                                                        item.priority === 'medium' ? 'bg-yellow-500' :
                                                        'bg-green-500'
                                                    }`}></div>
                                                    <div className="ml-3">
                                                        <p className="text-sm font-medium text-gray-900">{item.action}</p>
                                                        <p className="text-sm text-gray-500">Best season: {item.season} • Priority: {item.priority}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // Export Panel Component
    function ExportPanel({ formData }) {
        const [includeMap, setIncludeMap] = useState(true);
        const [includeImages, setIncludeImages] = useState(true);
        const [planName, setPlanName] = useState(`LEAP_Plan_${formData.property.name || 'Property'}`);
        
        const generatePDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set document properties
            doc.setProperties({
                title: `LEAP Plan - ${formData.property.name || 'Property'}`,
                subject: 'Landholder Environmental Action Plan',
                author: 'LEAP Tool',
                keywords: 'environment, action plan, land management',
                creator: 'LEAP'
            });
            
            // Add title page
            doc.addImage('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><rect width="100" height="20" fill="%231a3e1a"/><text x="50" y="15" font-family="Arial" font-size="12" fill="white" text-anchor="middle">LEAP</text></svg>', 'SVG', 80, 15, 40, 8);
            
            doc.setFontSize(24);
            doc.setTextColor(30, 90, 50);
            doc.text('Landholder Environmental Action Plan', 105, 40, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(50, 50, 50);
            doc.text(`Prepared for: ${formData.property.name || 'Unnamed Property'}`, 105, 60, { align: 'center' });
            doc.text(`Location: ${formData.property.location || 'Not specified'}`, 105, 70, { align: 'center' });
            doc.text(`Date: ${formatDate(new Date())}`, 105, 80, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated by the LEAP (Landholder Environmental Action Planner) tool', 105, 280, { align: 'center' });
            
            // Add property details page
            doc.addPage();
            doc.setFontSize(18);
            doc.setTextColor(30, 90, 50);
            doc.text('1. Property Details', 20, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50);
            doc.text(`Property Name: ${formData.property.name || 'Not specified'}`, 20, 35);
            doc.text(`Location: ${formData.property.location || 'Not specified'}`, 20, 45);
            doc.text(`Size: ${formData.property.size || 'Not specified'} hectares`, 20, 55);
            doc.text(`State: ${formData.property.state || 'Not specified'}`, 20, 65);
            doc.text(`Rainfall: ${formData.property.rainfall || 'Not specified'}`, 20, 75);
            doc.text(`Soil Type: ${formData.property.soilType || 'Not specified'}`, 20, 85);
            
            doc.setFont(undefined, 'bold');
            doc.text('Property Features:', 20, 100);
            doc.setFont(undefined, 'normal');
            let featureY = 110;
            formData.property.features.forEach(feature => {
                doc.text(`• ${feature}`, 25, featureY);
                featureY += 7;
                if (featureY > 280) {
                    doc.addPage();
                    featureY = 20;
                }
            });
            
            // Add problems page
            doc.addPage();
            doc.setFontSize(18);
            doc.setTextColor(30, 90, 50);
            doc.text('2. Identified Issues', 20, 20);
            
            doc.setFontSize(12);
            let problemY = 35;
            
            if (formData.problems.erosion.present) {
                doc.text(`• Soil erosion (${formData.problems.erosion.severity} severity)`, 20, problemY);
                problemY += 7;
            }
            
            if (formData.problems.weeds.length > 0) {
                doc.text(`• Weed problems: ${formData.problems.weeds.join(', ')}`, 20, problemY);
                problemY += 7;
            }
            
            if (formData.problems.habitatLoss.present) {
                doc.text(`• Habitat loss/degradation (${formData.problems.habitatLoss.severity} severity)`, 20, problemY);
                problemY += 7;
            }
            
            if (formData.problems.waterQuality.present) {
                doc.text(`• Water quality concerns (${formData.problems.waterQuality.severity} severity)`, 20, problemY);
                problemY += 7;
            }
            
            if (formData.problems.fireRisk.present) {
                doc.text(`• Bushfire risk (${formData.problems.fireRisk.severity} severity)`, 20, problemY);
                problemY += 7;
            }
            
            if (formData.problems.otherProblems) {
                doc.text(`• Other concerns: ${formData.problems.otherProblems}`, 20, problemY);
                problemY += 7;
            }
            
            // Add management goals
            doc.setFontSize(18);
            doc.setTextColor(30, 90, 50);
            doc.text('3. Management Goals', 20, problemY + 15);
            
            doc.setFontSize(12);
            let goalY = problemY + 30;
            formData.problems.goals.forEach(goal => {
                doc.text(`• ${goal}`, 20, goalY);
                goalY += 7;
                if (goalY > 280) {
                    doc.addPage();
                    goalY = 20;
                }
            });
            
            // Add map page if included
            if (includeMap && formData.mapZones.length > 0) {
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(30, 90, 50);
                doc.text('4. Property Map', 20, 20);
                
                doc.setFontSize(12);
                doc.text('The following map shows the zones you have identified:', 20, 35);
                
                // Create a legend
                doc.setFontSize(10);
                doc.setTextColor(50, 50, 50);
                
                const legendItems = [
                    { color: '#3388ff', label: 'Management Area' },
                    { color: '#ff0000', label: 'Problem Area' },
                    { color: '#33cc33', label: 'Sensitive Area' },
                    { color: '#ffcc00', label: 'Other Area' }
                ];
                
                let legendY = 50;
                legendItems.forEach(item => {
                    doc.setFillColor(item.color);
                    doc.rect(20, legendY, 5, 5, 'F');
                    doc.text(item.label, 28, legendY + 4);
                    legendY += 8;
                });
                
                // Add zone details
                doc.setFontSize(12);
                let zoneY = legendY + 15;
                formData.mapZones.forEach((zone, index) => {
                    doc.setTextColor(50, 50, 50);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${zone.name} (${zone.type})`, 20, zoneY);
                    doc.setFont(undefined, 'normal');
                    zoneY += 7;
                    
                    if (zone.notes) {
                        doc.text(`Notes: ${zone.notes}`, 25, zoneY);
                        zoneY += 7;
                    }
                    
                    // Add zone coordinates if it's a point
                    if (zone.coordinates.type === 'Point') {
                        const [lng, lat] = zone.coordinates.coordinates;
                        doc.text(`Location: ${lat.toFixed(6)}°N, ${lng.toFixed(6)}°E`, 25, zoneY);
                        zoneY += 7;
                    }
                    
                    zoneY += 5;
                    
                    if (zoneY > 280) {
                        doc.addPage();
                        zoneY = 20;
                    }
                });
            }
            
            // Add photos page if included
            if (includeImages && formData.photos.length > 0) {
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(30, 90, 50);
                doc.text('5. Site Photos', 20, 20);
                
                doc.setFontSize(12);
                doc.text('The following photos document conditions on your property:', 20, 35);
                
                let photoY = 45;
                let photoX = 20;
                let photoCount = 0;
                
                for (let i = 0; i < formData.photos.length; i++) {
                    const photo = formData.photos[i];
                    
                    try {
                        // Add photo to PDF (resized to fit)
                        const imgData = photo.url;
                        const imgProps = doc.getImageProperties(imgData);
                        const ratio = imgProps.width / imgProps.height;
                        const width = 80;
                        const height = width / ratio;
                        
                        // Check if we need a new page
                        if (photoY + height > 250) {
                            doc.addPage();
                            photoY = 20;
                            photoX = 20;
                        }
                        
                        doc.addImage(imgData, 'JPEG', photoX, photoY, width, height);
                        
                        // Add photo notes if available
                        if (photo.notes) {
                            doc.setFontSize(10);
                            doc.text(photo.notes, photoX, photoY + height + 5, { maxWidth: width });
                            doc.setFontSize(12);
                        }
                        
                        // Update position for next photo
                        if (photoX === 20) {
                            photoX = 110;
                        } else {
                            photoX = 20;
                            photoY += height + (photo.notes ? 15 : 10);
                        }
                        
                        photoCount++;
                        
                        // Limit number of photos to prevent PDF from becoming too large
                        if (photoCount >= 6) break;
                        
                    } catch (error) {
                        console.error("Error adding photo to PDF:", error);
                    }
                }
            }
            
            // Add recommendations
            doc.addPage();
            doc.setFontSize(18);
            doc.setTextColor(30, 90, 50);
            doc.text(includeMap || includeImages ? '6. Recommended Actions' : '4. Recommended Actions', 20, 20);
            
            doc.setFontSize(12);
            let recY = 35;
            formData.recommendations.forEach(rec => {
                doc.setFont(undefined, 'bold');
                doc.text(`${rec.title}:`, 20, recY);
                doc.setFont(undefined, 'normal');
                recY += 7;
                
                rec.actions.forEach(action => {
                    doc.text(`• ${action}`, 25, recY);
                    recY += 7;
                    if (recY > 280) {
                        doc.addPage();
                        recY = 20;
                    }
                });
                recY += 5;
            });
            
            // Add timeline
            doc.addPage();
            doc.setFontSize(18);
            doc.setTextColor(30, 90, 50);
            doc.text(includeMap || includeImages ? '7. Action Timeline' : '5. Action Timeline', 20, 20);
            
            doc.setFontSize(12);
            let timeY = 35;
            
            const timeGroups = {
                'Immediate Actions': formData.timeline.filter(item => item.timeframe === 'Immediate'),
                'Short Term (1-6 months)': formData.timeline.filter(item => 
                    item.timeframe === '1-3 months' || item.timeframe === '3-6 months'),
                'Medium Term (6-12 months)': formData.timeline.filter(item => 
                    item.timeframe === '6-12 months'),
                'Long Term (12+ months)': formData.timeline.filter(item => 
                    item.timeframe.includes('12'))
            };
            
            Object.entries(timeGroups).forEach(([title, items]) => {
                if (items.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text(title, 20, timeY);
                    doc.setFont(undefined, 'normal');
                    timeY += 7;
                    
                    items.forEach(item => {
                        doc.text(`• ${item.action} (Best in ${item.season}, ${item.priority} priority)`, 25, timeY);
                        timeY += 7;
                        if (timeY > 280) {
                            doc.addPage();
                            timeY = 20;
                        }
                    });
                    
                    timeY += 5;
                }
            });
            
            // Add footer to each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
                doc.text(`LEAP Plan - ${formData.property.name || 'Property'}`, 200, 287, { align: 'right' });
            }
            
            // Save the PDF
            doc.save(`${planName}.pdf`);
        };
        
        return (
            <div className="max-w-4xl mx-auto">
                <h2 className="text-2xl font-bold mb-6 text-green-800">Export Your Action Plan</h2>
                
                <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 className="text-xl font-medium mb-4 text-gray-800">Your plan is ready!</h3>
                    <p className="mb-6">Download your customized environmental action plan as a PDF document.</p>
                    
                    <div className="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 className="font-bold mb-4 text-lg">Plan Summary</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h5 className="font-medium mb-2 text-gray-700">Property Details</h5>
                                <ul className="space-y-1 text-sm">
                                    <li><span className="font-medium">Name:</span> {formData.property.name || 'Not specified'}</li>
                                    <li><span className="font-medium">Location:</span> {formData.property.location || 'Not specified'}</li>
                                    <li><span className="font-medium">Size:</span> {formData.property.size || 'Not specified'} hectares</li>
                                    <li><span className="font-medium">Features:</span> {formData.property.features.join(', ') || 'None specified'}</li>
                                </ul>
                            </div>
                            <div>
                                <h5 className="font-medium mb-2 text-gray-700">Plan Contents</h5>
                                <ul className="space-y-1 text-sm">
                                    <li><span className="font-medium">Identified issues:</span> {formData.timeline.length} priority actions</li>
                                    <li><span className="font-medium">Mapped zones:</span> {formData.mapZones.length} areas</li>
                                    <li><span className="font-medium">Recommendations:</span> {formData.recommendations.length} categories</li>
                                    <li><span className="font-medium">Timeline:</span> {formData.timeline.length} scheduled actions</li>
                                    <li><span className="font-medium">Photos:</span> {formData.photos.length} site photos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div className="mb-8">
                        <h4 className="font-bold mb-4 text-lg">Export Options</h4>
                        <div className="space-y-4">
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="include-map"
                                    checked={includeMap}
                                    onChange={() => setIncludeMap(!includeMap)}
                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                />
                                <label htmlFor="include-map" className="ml-2 block text-sm text-gray-700">
                                    Include property map in PDF
                                </label>
                            </div>
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="include-images"
                                    checked={includeImages}
                                    onChange={() => setIncludeImages(!includeImages)}
                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                />
                                <label htmlFor="include-images" className="ml-2 block text-sm text-gray-700">
                                    Include site photos in PDF
                                </label>
                            </div>
                            <div>
                                <label htmlFor="plan-name" className="block text-sm font-medium text-gray-700 mb-1">
                                    Plan file name
                                </label>
                                <input
                                    type="text"
                                    id="plan-name"
                                    value={planName}
                                    onChange={(e) => setPlanName(e.target.value)}
                                    className="w-full p-2 border rounded-lg"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex flex-col sm:flex-row gap-4">
                        <button
                            onClick={generatePDF}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex-1 flex items-center justify-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download PDF Plan
                        </button>
                        <button
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex-1 flex items-center justify-center"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            Email Plan
                        </button>
                    </div>
                    
                    <div className="mt-8 pt-6 border-t border-gray-200">
                        <h4 className="font-bold mb-3 text-lg">Next Steps</h4>
                        <ul className="space-y-2 text-sm text-gray-700">
                            <li className="flex items-start">
                                <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Review your plan and prioritize actions
                            </li>
                            <li className="flex items-start">
                                <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Contact local Landcare or NRM group for support
                            </li>
                            <li className="flex items-start">
                                <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Check for available grants or funding programs
                            </li>
                            <li className="flex items-start">
                                <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Schedule regular reviews of your progress
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
    
</body>
</html>
