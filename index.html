<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAP - Landholder Environmental Action Planner</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link 
      rel="stylesheet" 
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <link href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" rel="stylesheet"/>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; }
        .leaflet-top { z-index: 500 !important; }
        .help-tooltip {
            cursor: help;
            border-bottom: 1px dotted #999;
        }
        .zone-management { background-color: rgba(51, 136, 255, 0.2); border-color: #3388ff; }
        .zone-problem { background-color: rgba(255, 0, 0, 0.2); border-color: #ff0000; }
        .zone-sensitive { background-color: rgba(51, 204, 51, 0.2); border-color: #33cc33; }
        .zone-other { background-color: rgba(255, 204, 0, 0.2); border-color: #ffcc00; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Utility functions
        const formatDate = (date) => {
            return new Date(date).toLocaleDateString('en-AU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        // Sample data for demonstration
        const sampleWeeds = {
            'NSW': ['African lovegrass', 'Blackberry', 'Gorse', 'Lantana', 'Serrated tussock'],
            'VIC': ['Bridal creeper', 'Gorse', 'Paterson\'s curse', 'Willows', 'English broom'],
            'QLD': ['Lantana', 'Parthenium weed', 'Pond apple', 'Rubber vine', 'Singapore daisy'],
            'WA': ['Arum lily', 'Bridal creeper', 'Watsonia', 'Geraldton carnation weed', 'Ehrharta'],
            'SA': ['Olive', 'Bridal creeper', 'Geraldton carnation weed', 'Buffel grass', 'Horehound'],
            'TAS': ['Gorse', 'Broom', 'Willows', 'Holly', 'Spanish heath'],
            'NT': ['Gamba grass', 'Parkinsonia', 'Rubber vine', 'Pond apple', 'Mimosa pigra']
        };

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Error caught by boundary:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return <div className="p-4 bg-red-100 text-red-800">
                        <h3>Something went wrong</h3>
                        <p>Please try refreshing the page or going back.</p>
                    </div>;
                }
                return this.props.children;
            }
        }

        // Main App Component
        function App() {
            const [currentStep, setCurrentStep] = useState(0);
            const [formData, setFormData] = useState({
                property: {
                    name: '',
                    size: '',
                    location: '',
                    state: '',
                    features: [],
                    rainfall: '',
                    soilType: ''
                },
                problems: {
                    erosion: { present: false, severity: 'low' },
                    weeds: [],
                    habitatLoss: { present: false, severity: 'low' },
                    waterQuality: { present: false, severity: 'low' },
                    fireRisk: { present: false, severity: 'low' },
                    otherProblems: '',
                    goals: []
                },
                mapZones: [],
                recommendations: [],
                timeline: []
            });

            const steps = [
                { title: 'Welcome', icon: 'üè†' },
                { title: 'Property Details', icon: 'üìã' },
                { title: 'Identify Problems', icon: '‚ö†Ô∏è' },
                { title: 'Map Your Property', icon: 'üó∫Ô∏è' },
                { title: 'Recommendations', icon: 'üí°' },
                { title: 'Action Timeline', icon: 'üìÖ' },
                { title: 'Export Plan', icon: 'üì§' }
            ];

            const propertyFeatures = [
                'Creeks or rivers',
                'Native vegetation',
                'Wetlands',
                'Rocky outcrops',
                'Existing fencing',
                'Farm infrastructure',
                'Pasture areas',
                'Forest/woodland'
            ];

            const managementGoals = [
                'Improve biodiversity',
                'Control invasive species',
                'Reduce erosion',
                'Improve water quality',
                'Enhance farm productivity',
                'Create wildlife habitat',
                'Reduce fire risk',
                'Carbon sequestration'
            ];

            const nextStep = () => {
                // Validate before proceeding
                if (currentStep === 1 && !formData.property.name) {
                    alert('Please at least provide a property name');
                    return;
                }
                setCurrentStep(prev => Math.min(prev + 1, steps.length - 1));
            };
            
            const prevStep = () => setCurrentStep(prev => Math.max(prev - 1, 0));

            const updateFormData = (section, data) => {
                setFormData(prev => ({
                    ...prev,
                    [section]: { ...prev[section], ...data }
                }));
            };

            const addMapZone = (zone) => {
                setFormData(prev => ({
                    ...prev,
                    mapZones: [...prev.mapZones, zone]
                }));
            };

            const updateZone = (id, updates) => {
                setFormData(prev => ({
                    ...prev,
                    mapZones: prev.mapZones.map((zone, index) => 
                        index === id ? { ...zone, ...updates } : zone
                    )
                }));
            };

            const removeZone = (id) => {
                setFormData(prev => ({
                    ...prev,
                    mapZones: prev.mapZones.filter((_, index) => index !== id)
                }));
            };

            const generateRecommendations = () => {
                const recs = [];
                const timeline = [];
                const now = new Date();
                
                // Weed management recommendations
                if (formData.problems.weeds.length > 0) {
                    const weedActions = [];
                    
                    if (formData.problems.weeds.some(w => ['Gorse', 'Blackberry', 'Lantana'].includes(w))) {
                        weedActions.push('Mechanical removal followed by herbicide application');
                        timeline.push({
                            action: 'Initial weed control',
                            timeframe: '1-3 months',
                            season: formData.property.state === 'TAS' ? 'Spring' : 'Late winter',
                            priority: 'high'
                        });
                    }
                    
                    if (formData.problems.weeds.some(w => ['Serrated tussock', 'African lovegrass'].includes(w))) {
                        weedActions.push('Pasture improvement to outcompete weeds');
                        timeline.push({
                            action: 'Pasture assessment',
                            timeframe: '1-2 months',
                            season: 'Autumn',
                            priority: 'medium'
                        });
                    }
                    
                    weedActions.push(
                        'Implement follow-up monitoring program',
                        'Consider biological controls where available'
                    );
                    
                    recs.push({
                        title: 'Weed Management',
                        category: 'vegetation',
                        actions: weedActions,
                        priority: 'high'
                    });
                    
                    timeline.push({
                        action: 'Follow-up weed control',
                        timeframe: '6-12 months',
                        season: 'Depends on species',
                        priority: 'high'
                    });
                }
                
                // Erosion control
                if (formData.problems.erosion.present) {
                    const severity = formData.problems.erosion.severity;
                    const erosionActions = [];
                    
                    erosionActions.push('Identify erosion hotspots on your map');
                    
                    if (severity === 'high') {
                        erosionActions.push(
                            'Consult with NRM officer about erosion control structures',
                            'Prioritize areas with greatest erosion risk'
                        );
                        timeline.push({
                            action: 'Erosion control works',
                            timeframe: 'Immediate',
                            season: 'Dry season',
                            priority: 'high'
                        });
                    } else {
                        erosionActions.push(
                            'Revegetate with deep-rooted native species',
                            'Minimize ground disturbance in vulnerable areas'
                        );
                        timeline.push({
                            action: 'Erosion control planting',
                            timeframe: '3-6 months',
                            season: 'Winter/Spring',
                            priority: severity === 'medium' ? 'high' : 'medium'
                        });
                    }
                    
                    recs.push({
                        title: 'Erosion Control',
                        category: 'soil',
                        actions: erosionActions,
                        priority: severity === 'high' ? 'high' : 'medium'
                    });
                }
                
                // Habitat restoration
                if (formData.problems.habitatLoss.present || formData.problems.goals.includes('Improve biodiversity')) {
                    recs.push({
                        title: 'Habitat Restoration',
                        category: 'biodiversity',
                        actions: [
                            'Plant locally native vegetation to create wildlife corridors',
                            formData.property.features.includes('Creeks or rivers') 
                                ? 'Establish riparian buffers along waterways' 
                                : 'Identify areas for habitat restoration on your map',
                            'Consider fencing to protect sensitive areas from stock',
                            'Install nest boxes for hollow-dependent species'
                        ],
                        priority: 'medium'
                    });
                    
                    timeline.push({
                        action: 'Habitat restoration planting',
                        timeframe: '6-12 months',
                        season: 'Winter/Spring',
                        priority: 'medium'
                    });
                }
                
                // Fire management
                if (formData.problems.fireRisk.present) {
                    recs.push({
                        title: 'Fire Risk Reduction',
                        category: 'fire',
                        actions: [
                            'Create asset protection zones around buildings',
                            'Implement fuel reduction program',
                            'Consider fire access trails',
                            'Develop fire management plan'
                        ],
                        priority: 'high'
                    });
                    
                    timeline.push({
                        action: 'Fire preparedness works',
                        timeframe: 'Before fire season',
                        season: 'Spring',
                        priority: 'high'
                    });
                }
                
                // Water quality
                if (formData.problems.waterQuality.present || formData.property.features.includes('Creeks or rivers')) {
                    recs.push({
                        title: 'Waterway Management',
                        category: 'water',
                        actions: [
                            'Fence off waterways from stock if possible',
                            'Establish riparian vegetation buffers',
                            'Monitor water quality indicators',
                            'Control erosion in catchment areas'
                        ],
                        priority: 'medium'
                    });
                    
                    timeline.push({
                        action: 'Waterway protection works',
                        timeframe: '6-12 months',
                        season: 'When water levels are low',
                        priority: 'medium'
                    });
                }
                
                updateFormData('recommendations', recs);
                updateFormData('timeline', timeline);
            };

            useEffect(() => {
                if (currentStep === 4) { // Recommendations step
                    generateRecommendations();
                }
            }, [currentStep, formData.problems, formData.property.features, formData.property.state]);

            const renderStep = () => {
                switch(currentStep) {
                    case 0:
                        return <WelcomeScreen nextStep={nextStep} />;
                    case 1:
                        return <PropertyForm 
                            data={formData.property} 
                            update={(data) => updateFormData('property', data)} 
                            features={propertyFeatures}
                            sampleWeeds={sampleWeeds}
                        />;
                    case 2:
                        return <ProblemForm 
                            data={formData.problems} 
                            update={(data) => updateFormData('problems', data)} 
                            sampleWeeds={sampleWeeds}
                            goals={managementGoals}
                            state={formData.property.state}
                        />;
                    case 3:
                        return <MapTool 
                            zones={formData.mapZones} 
                            addZone={addMapZone}
                            updateZone={updateZone}
                            removeZone={removeZone}
                            propertyName={formData.property.name}
                            location={formData.property.location}
                        />;
                    case 4:
                        return <Recommendations 
                            recommendations={formData.recommendations} 
                            problems={formData.problems}
                        />;
                    case 5:
                        return <Timeline 
                            timeline={formData.timeline} 
                            recommendations={formData.recommendations}
                        />;
                    case 6:
                        return <ExportPanel formData={formData} />;
                    default:
                        return <WelcomeScreen nextStep={nextStep} />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-green-700 text-white p-4 shadow-md">
                        <div className="container mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold">LEAP</h1>
                                <p className="text-sm">Landholder Environmental Action Planner</p>
                            </div>
                            <div className="text-sm">
                                {formData.property.name && `Property: ${formData.property.name}`}
                            </div>
                        </div>
                    </header>
                    
                    <div className="container mx-auto p-4 flex-grow">
                        {/* Progress indicator */}
                        <div className="mb-8">
                            <div className="flex justify-between mb-2">
                                {steps.map((step, index) => (
                                    <div 
                                        key={index}
                                        className={`text-sm text-center ${currentStep >= index ? 'font-bold text-green-700' : 'text-gray-500'}`}
                                        style={{ width: `${100/steps.length}%` }}
                                    >
                                        <div className="text-lg mb-1">{step.icon}</div>
                                        <div>{step.title}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2.5">
                                <div 
                                    className="bg-green-600 h-2.5 rounded-full" 
                                    style={{ width: `${(currentStep / (steps.length - 1)) * 100}%` }}
                                ></div>
                            </div>
                        </div>
                        
                        {/* Main content */}
                        <ErrorBoundary>
                            {renderStep()}
                        </ErrorBoundary>
                    </div>
                    
                    <footer className="bg-gray-100 p-4 border-t">
                        <div className="container mx-auto flex justify-between items-center">
                            <button 
                                onClick={prevStep}
                                disabled={currentStep === 0}
                                className={`px-4 py-2 rounded flex items-center ${currentStep === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-gray-300 hover:bg-gray-400'}`}
                            >
                                ‚Üê Back
                            </button>
                            <div className="text-sm text-gray-600">
                                Step {currentStep + 1} of {steps.length}
                            </div>
                            <button 
                                onClick={nextStep}
                                className={`px-4 py-2 rounded flex items-center ${currentStep === steps.length - 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                            >
                                {currentStep === steps.length - 1 ? 'Finish' : 'Next ‚Üí'}
                            </button>
                        </div>
                    </footer>
                </div>
            );
        }

        // Welcome Screen Component
        function WelcomeScreen({ nextStep }) {
            return (
                <div className="text-center py-8">
                    <div className="max-w-3xl mx-auto">
                        <h2 className="text-3xl font-bold mb-6 text-green-800">Welcome to LEAP</h2>
                        <p className="mb-6 text-lg">The Landholder Environmental Action Planner helps you create a customized plan for sustainable land management.</p>
                        
                        <div className="grid md:grid-cols-3 gap-6 mb-10">
                            <div className="bg-white p-6 rounded-lg shadow-md border border-green-100">
                                <div className="text-4xl mb-3">üèûÔ∏è</div>
                                <h3 className="font-bold mb-2">Property Assessment</h3>
                                <p className="text-sm">Document your property's features and identify environmental priorities.</p>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-md border border-green-100">
                                <div className="text-4xl mb-3">üó∫Ô∏è</div>
                                <h3 className="font-bold mb-2">Interactive Mapping</h3>
                                <p className="text-sm">Mark areas needing attention directly on your property map.</p>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-md border border-green-100">
                                <div className="text-4xl mb-3">üìã</div>
                                <h3 className="font-bold mb-2">Action Plan</h3>
                                <p className="text-sm">Get customized recommendations and create a timeline for implementation.</p>
                            </div>
                        </div>
                        
                        <div className="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mb-8 border border-green-200">
                            <h3 className="font-bold mb-4 text-green-700">Ready to begin?</h3>
                            <p className="mb-4">This tool will guide you through creating your environmental action plan in 7 simple steps.</p>
                            <p className="text-sm text-gray-600">You can save your progress at any time and return later.</p>
                        </div>
                        
                        <button 
                            onClick={nextStep}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg shadow-md transition duration-200 transform hover:scale-105"
                        >
                            Start Planning ‚Üí
                        </button>
                    </div>
                </div>
            );
        }

        // Property Form Component
        function PropertyForm({ data, update, features, sampleWeeds }) {
            const [localData, setLocalData] = useState(data);
            const [showWeedPreview, setShowWeedPreview] = useState(false);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setLocalData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleFeatureToggle = (feature) => {
                setLocalData(prev => {
                    const newFeatures = prev.features.includes(feature)
                        ? prev.features.filter(f => f !== feature)
                        : [...prev.features, feature];
                    return { ...prev, features: newFeatures };
                });
            };

            useEffect(() => {
                update(localData);
            }, [localData]);

            return (
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-green-800">Tell us about your property</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div className="mb-6">
                            <label className="block text-sm font-medium mb-1 text-gray-700">
                                Property name <span className="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                name="name"
                                value={localData.name}
                                onChange={handleChange}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                placeholder="e.g., Riverbend Farm"
                                required
                            />
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Property size (hectares)
                                </label>
                                <input
                                    type="number"
                                    name="size"
                                    value={localData.size}
                                    onChange={handleChange}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="e.g., 50"
                                    min="0"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Nearest town
                                </label>
                                <input
                                    type="text"
                                    name="location"
                                    value={localData.location}
                                    onChange={handleChange}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="e.g., Bega, NSW"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    State/Territory
                                </label>
                                <select
                                    name="state"
                                    value={localData.state}
                                    onChange={handleChange}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                >
                                    <option value="">Select...</option>
                                    <option value="NSW">New South Wales</option>
                                    <option value="VIC">Victoria</option>
                                    <option value="QLD">Queensland</option>
                                    <option value="WA">Western Australia</option>
                                    <option value="SA">South Australia</option>
                                    <option value="TAS">Tasmania</option>
                                    <option value="NT">Northern Territory</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Average annual rainfall (mm)
                                </label>
                                <select
                                    name="rainfall"
                                    value={localData.rainfall}
                                    onChange={handleChange}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                >
                                    <option value="">Select...</option>
                                    <option value="<250">Less than 250mm</option>
                                    <option value="250-500">250-500mm</option>
                                    <option value="500-750">500-750mm</option>
                                    <option value="750-1000">750-1000mm</option>
                                    <option value=">1000">More than 1000mm</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Dominant soil type
                                </label>
                                <select
                                    name="soilType"
                                    value={localData.soilType}
                                    onChange={handleChange}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                >
                                    <option value="">Select...</option>
                                    <option value="clay">Clay</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="loam">Loam</option>
                                    <option value="rocky">Rocky</option>
                                    <option value="volcanic">Volcanic</option>
                                    <option value="alluvial">Alluvial</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="mb-6">
                            <label className="block text-sm font-medium mb-2 text-gray-700">
                                What features does your property have? <span className="help-tooltip" title="Select all that apply">(?)</span>
                            </label>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {features.map(feature => (
                                    <div key={feature} className="flex items-start">
                                        <div className="flex items-center h-5">
                                            <input
                                                type="checkbox"
                                                id={`feature-${feature}`}
                                                checked={localData.features.includes(feature)}
                                                onChange={() => handleFeatureToggle(feature)}
                                                className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                            />
                                        </div>
                                        <label htmlFor={`feature-${feature}`} className="ml-2 block text-sm text-gray-700">
                                            {feature}
                                        </label>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {localData.state && (
                            <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-medium text-blue-800">
                                        Common weeds in {localData.state}:
                                    </h3>
                                    <button 
                                        onClick={() => setShowWeedPreview(!showWeedPreview)}
                                        className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                    >
                                        {showWeedPreview ? 'Hide' : 'Show'}
                                    </button>
                                </div>
                                {showWeedPreview && (
                                    <div className="mt-2">
                                        <p className="text-sm text-gray-600 mb-2">These may help when identifying problems in the next step:</p>
                                        <div className="flex flex-wrap gap-2">
                                            {sampleWeeds[localData.state]?.map(weed => (
                                                <span key={weed} className="bg-white px-2 py-1 rounded text-sm border">
                                                    {weed}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Problem Form Component
        function ProblemForm({ data, update, sampleWeeds, goals, state }) {
            const [localData, setLocalData] = useState(data);
            const [otherWeed, setOtherWeed] = useState('');
            const [otherGoal, setOtherGoal] = useState('');

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (name.includes('.')) {
                    // Handle nested properties (e.g., erosion.present)
                    const [parent, child] = name.split('.');
                    setLocalData(prev => ({
                        ...prev,
                        [parent]: {
                            ...prev[parent],
                            [child]: type === 'checkbox' ? checked : value
                        }
                    }));
                } else {
                    setLocalData(prev => ({
                        ...prev,
                        [name]: type === 'checkbox' ? checked : value
                    }));
                }
            };

            const handleWeedToggle = (weed) => {
                setLocalData(prev => {
                    let newWeeds;
                    if (weed === 'Other (please specify)') {
                        // Handle other weed specially
                        newWeeds = prev.weeds.includes(weed)
                            ? prev.weeds.filter(w => w !== weed && w !== otherWeed)
                            : [...prev.weeds, weed];
                    } else {
                        newWeeds = prev.weeds.includes(weed)
                            ? prev.weeds.filter(w => w !== weed)
                            : [...prev.weeds, weed];
                    }
                    return { ...prev, weeds: newWeeds };
                });
            };

            const addOtherWeed = () => {
                if (otherWeed.trim() && !localData.weeds.includes(otherWeed)) {
                    setLocalData(prev => ({
                        ...prev,
                        weeds: [...prev.weeds.filter(w => w !== 'Other (please specify)'), otherWeed]
                    }));
                    setOtherWeed('');
                }
            };

            const handleGoalToggle = (goal) => {
                setLocalData(prev => {
                    let newGoals;
                    if (goal === 'Other (please specify)') {
                        // Handle other goal specially
                        newGoals = prev.goals.includes(goal)
                            ? prev.goals.filter(g => g !== goal && g !== otherGoal)
                            : [...prev.goals, goal];
                    } else {
                        newGoals = prev.goals.includes(goal)
                            ? prev.goals.filter(g => g !== goal)
                            : [...prev.goals, goal];
                    }
                    return { ...prev, goals: newGoals };
                });
            };

            const addOtherGoal = () => {
                if (otherGoal.trim() && !localData.goals.includes(otherGoal)) {
                    setLocalData(prev => ({
                        ...prev,
                        goals: [...prev.goals.filter(g => g !== 'Other (please specify)'), otherGoal]
                    }));
                    setOtherGoal('');
                }
            };

            useEffect(() => {
                update(localData);
            }, [localData]);

            return (
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-green-800">Identify your property's environmental priorities</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-8">
                        <div>
                            <h3 className="text-lg font-medium mb-4 text-gray-800">Environmental Issues</h3>
                            <div className="space-y-6">
                                {[
                                    { 
                                        id: 'erosion', 
                                        label: 'Soil erosion',
                                        description: 'Loss of topsoil through water or wind action'
                                    },
                                    { 
                                        id: 'habitatLoss', 
                                        label: 'Habitat loss or degradation',
                                        description: 'Decline in native vegetation or wildlife habitat'
                                    },
                                    { 
                                        id: 'waterQuality', 
                                        label: 'Water quality concerns',
                                        description: 'Issues with turbidity, nutrients, or pollution in water bodies'
                                    },
                                    { 
                                        id: 'fireRisk', 
                                        label: 'Bushfire risk',
                                        description: 'Areas with high fuel load or near assets'
                                    }
                                ].map(issue => (
                                    <div key={issue.id} className="border-b pb-4 last:border-b-0">
                                        <div className="flex items-start">
                                            <div className="flex items-center h-5">
                                                <input
                                                    type="checkbox"
                                                    id={`${issue.id}-present`}
                                                    name={`${issue.id}.present`}
                                                    checked={localData[issue.id].present}
                                                    onChange={handleChange}
                                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                                />
                                            </div>
                                            <div className="ml-3 flex-1">
                                                <label htmlFor={`${issue.id}-present`} className="block text-sm font-medium text-gray-700">
                                                    {issue.label}
                                                </label>
                                                <p className="text-sm text-gray-500">{issue.description}</p>
                                                
                                                {localData[issue.id].present && (
                                                    <div className="mt-2">
                                                        <label className="block text-xs font-medium text-gray-500 mb-1">Severity:</label>
                                                        <div className="flex space-x-4">
                                                            {['low', 'medium', 'high'].map(level => (
                                                                <div key={level} className="flex items-center">
                                                                    <input
                                                                        type="radio"
                                                                        id={`${issue.id}-${level}`}
                                                                        name={`${issue.id}.severity`}
                                                                        value={level}
                                                                        checked={localData[issue.id].severity === level}
                                                                        onChange={handleChange}
                                                                        className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300"
                                                                    />
                                                                    <label htmlFor={`${issue.id}-${level}`} className="ml-2 block text-sm text-gray-700 capitalize">
                                                                        {level}
                                                                    </label>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div>
                            <h3 className="text-lg font-medium mb-3 text-gray-800">Weed Problems</h3>
                            <p className="text-sm text-gray-600 mb-4">Select all weed species present on your property:</p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                {sampleWeeds[state]?.map(weed => (
                                    <div key={weed} className="flex items-start">
                                        <div className="flex items-center h-5">
                                            <input
                                                type="checkbox"
                                                id={`weed-${weed}`}
                                                checked={localData.weeds.includes(weed)}
                                                onChange={() => handleWeedToggle(weed)}
                                                className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                            />
                                        </div>
                                        <label htmlFor={`weed-${weed}`} className="ml-2 block text-sm text-gray-700">
                                            {weed}
                                        </label>
                                    </div>
                                ))}
                                
                                <div className="flex items-start">
                                    <div className="flex items-center h-5">
                                        <input
                                            type="checkbox"
                                            id="weed-other"
                                            checked={localData.weeds.includes('Other (please specify)') || 
                                                     localData.weeds.some(w => !sampleWeeds[state]?.includes(w))}
                                            onChange={() => handleWeedToggle('Other (please specify)')}
                                            className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                        />
                                    </div>
                                    <label htmlFor="weed-other" className="ml-2 block text-sm text-gray-700">
                                        Other (please specify)
                                    </label>
                                </div>
                            </div>
                            
                            {(localData.weeds.includes('Other (please specify)') || 
                              localData.weeds.some(w => !sampleWeeds[state]?.includes(w))) && (
                                <div className="flex gap-2 mt-2">
                                    <input
                                        type="text"
                                        value={otherWeed}
                                        onChange={(e) => setOtherWeed(e.target.value)}
                                        placeholder="Specify weed species"
                                        className="flex-grow p-2 border rounded-lg text-sm"
                                    />
                                    <button 
                                        onClick={addOtherWeed}
                                        className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                    >
                                        Add
                                    </button>
                                </div>
                            )}
                            
                            {localData.weeds.length > 0 && (
                                <div className="mt-3">
                                    <p className="text-sm font-medium">Selected weeds:</p>
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        {localData.weeds.map(weed => (
                                            <span key={weed} className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                                {weed}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div>
                            <h3 className="text-lg font-medium mb-3 text-gray-800">Management Goals</h3>
                            <p className="text-sm text-gray-600 mb-4">What are your main objectives for your property?</p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                {goals.map(goal => (
                                    <div key={goal} className="flex items-start">
                                        <div className="flex items-center h-5">
                                            <input
                                                type="checkbox"
                                                id={`goal-${goal}`}
                                                checked={localData.goals.includes(goal)}
                                                onChange={() => handleGoalToggle(goal)}
                                                className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                            />
                                        </div>
                                        <label htmlFor={`goal-${goal}`} className="ml-2 block text-sm text-gray-700">
                                            {goal}
                                        </label>
                                    </div>
                                ))}
                                
                                <div className="flex items-start">
                                    <div className="flex items-center h-5">
                                        <input
                                            type="checkbox"
                                            id="goal-other"
                                            checked={localData.goals.includes('Other (please specify)') || 
                                                     localData.goals.some(g => !goals.includes(g))}
                                            onChange={() => handleGoalToggle('Other (please specify)')}
                                            className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                        />
                                    </div>
                                    <label htmlFor="goal-other" className="ml-2 block text-sm text-gray-700">
                                        Other (please specify)
                                    </label>
                                </div>
                            </div>
                            
                            {(localData.goals.includes('Other (please specify)') || 
                              localData.goals.some(g => !goals.includes(g))) && (
                                <div className="flex gap-2 mt-2">
                                    <input
                                        type="text"
                                        value={otherGoal}
                                        onChange={(e) => setOtherGoal(e.target.value)}
                                        placeholder="Specify your goal"
                                        className="flex-grow p-2 border rounded-lg text-sm"
                                    />
                                    <button 
                                        onClick={addOtherGoal}
                                        className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                    >
                                        Add
                                    </button>
                                </div>
                            )}
                            
                            {localData.goals.length > 0 && (
                                <div className="mt-3">
                                    <p className="text-sm font-medium">Selected goals:</p>
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        {localData.goals.map(goal => (
                                            <span key={goal} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                {goal}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-700">
                                Any other environmental concerns or notes?
                            </label>
                            <textarea
                                name="otherProblems"
                                value={localData.otherProblems}
                                onChange={handleChange}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 h-24"
                                placeholder="e.g., feral animals, salinity, drought impacts..."
                            ></textarea>
                        </div>
                    </div>
                </div>
            );
        }

        // Map Tool Component
        function MapTool({ zones, addZone, updateZone, removeZone, propertyName, location }) {
            const [map, setMap] = useState(null);
            const [drawnItems, setDrawnItems] = useState(null);
            const [zoneName, setZoneName] = useState('');
            const [zoneType, setZoneType] = useState('management');
            const [zoneNotes, setZoneNotes] = useState('');
            const [editingZone, setEditingZone] = useState(null);
            const [mapInitialized, setMapInitialized] = useState(false);
            const mapRef = useRef(null);
            
            // Initialize map
            useEffect(() => {
                if (!mapInitialized && mapRef.current && window.L) {
                    const newMap = window.L.map(mapRef.current).setView([-35.0, 149.0], 10);
                    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(newMap);
                    
                    // Initialize the FeatureGroup to store editable layers
                    const items = new window.L.FeatureGroup();
                    newMap.addLayer(items);
                    
                    // Add draw control
                    const drawControl = new window.L.Control.Draw({
                        edit: {
                            featureGroup: items,
                            edit: false // Disable editing for now
                        },
                        draw: {
                            polygon: {
                                allowIntersection: false,
                                drawError: {
                                    color: '#e1e100',
                                    message: '<strong>Error:<strong> shape edges cannot cross!'
                                },
                                shapeOptions: {
                                    color: '#3388ff',
                                    fillOpacity: 0.2
                                }
                            },
                            rectangle: true,
                            circle: false,
                            marker: false,
                            circlemarker: false,
                            polyline: false
                        }
                    });
                    newMap.addControl(drawControl);
                    
                    // Handle created shapes
                    newMap.on(window.L.Draw.Event.CREATED, (e) => {
                        const layer = e.layer;
                        items.addLayer(layer);
                        
                        // Generate a color based on zone type
                        const colors = {
                            management: '#3388ff',
                            problem: '#ff0000',
                            sensitive: '#33cc33',
                            other: '#ffcc00'
                        };
                        
                        layer.setStyle({
                            color: colors[zoneType] || '#3388ff',
                            fillColor: colors[zoneType] || '#3388ff',
                            fillOpacity: 0.2,
                            weight: 2
                        });
                        
                        // Add popup with zone info
                        layer.bindPopup(`<b>${zoneName || 'Unnamed zone'}</b><br>Type: ${zoneType}`);
                    });
                    
                    setMap(newMap);
                    setDrawnItems(items);
                    setMapInitialized(true);
                }
                
                // Cleanup on unmount
                return () => {
                    if (map) {
                        map.remove();
                    }
                };
            }, [mapInitialized, zoneType, zoneName]);
            
            // Add existing zones to map when they change
            useEffect(() => {
                if (map && drawnItems) {
                    // Clear existing layers
                    drawnItems.clearLayers();
                    
                    // Add each zone as a layer
                    zones.forEach((zone, index) => {
                        const layer = window.L.geoJSON(zone.coordinates);
                        
                        // Style based on zone type
                        const colors = {
                            management: '#3388ff',
                            problem: '#ff0000',
                            sensitive: '#33cc33',
                            other: '#ffcc00'
                        };
                        
                        layer.setStyle({
                            color: colors[zone.type] || '#3388ff',
                            fillColor: colors[zone.type] || '#3388ff',
                            fillOpacity: 0.2,
                            weight: 2
                        });
                        
                        // Add popup with zone info
                        layer.bindPopup(`
                            <b>${zone.name}</b><br>
                            Type: ${zone.type}<br>
                            ${zone.notes ? `Notes: ${zone.notes}` : ''}
                            <div class="mt-2">
                                <button onclick="window.editZone(${index})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">
                                    Edit
                                </button>
                                <button onclick="window.deleteZone(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-xs ml-1">
                                    Delete
                                </button>
                            </div>
                        `);
                        
                        drawnItems.addLayer(layer);
                    });
                    
                    // Fit map to show all zones if there are any
                    if (zones.length > 0) {
                        map.fitBounds(drawnItems.getBounds());
                    }
                }
            }, [zones, map, drawnItems]);
            
            // Expose functions to window for popup buttons
            useEffect(() => {
                window.editZone = (index) => {
                    setEditingZone(index);
                    const zone = zones[index];
                    setZoneName(zone.name);
                    setZoneType(zone.type);
                    setZoneNotes(zone.notes || '');
                    
                    // Highlight the zone being edited
                    drawnItems.eachLayer(layer => {
                        if (layer._leaflet_id === zones[index].coordinates.id) {
                            layer.setStyle({ weight: 4, fillOpacity: 0.3 });
                        } else {
                            layer.setStyle({ weight: 2, fillOpacity: 0.2 });
                        }
                    });
                };
                
                window.deleteZone = (index) => {
                    if (confirm('Are you sure you want to delete this zone?')) {
                        removeZone(index);
                    }
                };
                
                return () => {
                    window.editZone = undefined;
                    window.deleteZone = undefined;
                };
            }, [zones, removeZone, drawnItems]);
            
            const saveZone = () => {
                if (drawnItems && zoneName) {
                    const layers = drawnItems.getLayers();
                    if (layers.length > 0) {
                        const latestLayer = layers[layers.length - 1];
                        
                        if (!latestLayer.toGeoJSON) {
                            alert('Error: Map data not ready. Please try drawing your zone again.');
                            return;
                        }

                        const zone = {
                            name: zoneName,
                            type: zoneType,
                            notes: zoneNotes,
                            coordinates: latestLayer.toGeoJSON().geometry
                        };
                        
                        if (editingZone !== null) {
                            updateZone(editingZone, zone);
                            setEditingZone(null);
                        } else {
                            addZone(zone);
                        }
                        
                        // Reset form
                        setZoneName('');
                        setZoneNotes('');
                    } else {
                        alert('Please draw a zone on the map first');
                    }
                } else {
                    alert('Please provide a zone name');
                }
            };
            
            const cancelEdit = () => {
                setEditingZone(null);
                setZoneName('');
                setZoneNotes('');
                
                // Reset layer styles
                if (drawnItems) {
                    drawnItems.eachLayer(layer => {
                        layer.setStyle({ weight: 2, fillOpacity: 0.2 });
                    });
                }
            };
            
            return (
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-green-800">Map your property zones</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <p className="mb-6">Draw areas on the map to identify different zones (e.g., weed areas, sensitive ecosystems, planned works). Click on zones to edit or delete them.</p>
                        
                        <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Zone name <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    value={zoneName}
                                    onChange={(e) => setZoneName(e.target.value)}
                                    className="w-full p-2 border rounded-lg"
                                    placeholder="e.g., North paddock weeds"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Zone type
                                </label>
                                <select
                                    value={zoneType}
                                    onChange={(e) => setZoneType(e.target.value)}
                                    className="w-full p-2 border rounded-lg"
                                >
                                    <option value="management">Management area</option>
                                    <option value="problem">Problem area</option>
                                    <option value="sensitive">Sensitive area</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">
                                    Notes (optional)
                                </label>
                                <input
                                    type="text"
                                    value={zoneNotes}
                                    onChange={(e) => setZoneNotes(e.target.value)}
                                    className="w-full p-2 border rounded-lg"
                                    placeholder="e.g., High priority area"
                                />
                            </div>
                            <div className="flex items-end space-x-2">
                                <button
                                    onClick={saveZone}
                                    disabled={!zoneName}
                                    className={`px-4 py-2 rounded-lg flex-1 ${!zoneName ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                                >
                                    {editingZone !== null ? 'Update Zone' : 'Save Zone'}
                                </button>
                                {editingZone !== null && (
                                    <button
                                        onClick={cancelEdit}
                                        className="px-3 py-2 rounded-lg bg-gray-300 hover:bg-gray-400"
                                    >
                                        Cancel
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        <div ref={mapRef} id="map" className="mb-6 rounded-lg overflow-hidden border border-gray-300"></div>
                        
                        <div>
                            <h3 className="font-medium mb-3 text-gray-800">Your saved zones:</h3>
                            {zones.length === 0 ? (
                                <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No zones saved yet. Draw on the map, fill in details above, and click "Save Zone".</p>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
function MapTool({ zones, addZone, updateZone, removeZone, propertyName, location }) {
    const [map, setMap] = useState(null);
    const [drawnItems, setDrawnItems] = useState(null);
    const [zoneName, setZoneName] = useState('');
    const [zoneType, setZoneType] = useState('management');
    const [zoneNotes, setZoneNotes] = useState('');
    const [editingZone, setEditingZone] = useState(null);
    const [mapInitialized, setMapInitialized] = useState(false);
    const [hasDrawnZone, setHasDrawnZone] = useState(false); // New state to track if a zone has been drawn
    const mapRef = useRef(null);
    
    // Initialize map
    useEffect(() => {
        if (!mapInitialized && mapRef.current && window.L) {
            const newMap = window.L.map(mapRef.current).setView([-35.0, 149.0], 10);
            window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(newMap);
            
            // Initialize the FeatureGroup to store editable layers
            const items = new window.L.FeatureGroup();
            newMap.addLayer(items);
            
            // Add draw control
            const drawControl = new window.L.Control.Draw({
                edit: {
                    featureGroup: items,
                    edit: false // Disable editing for now
                },
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Error:<strong> shape edges cannot cross!'
                        },
                        shapeOptions: {
                            color: '#3388ff',
                            fillOpacity: 0.2
                        }
                    },
                    rectangle: true,
                    circle: false,
                    marker: false,
                    circlemarker: false,
                    polyline: false
                }
            });
            newMap.addControl(drawControl);
            
            // Handle created shapes
            newMap.on(window.L.Draw.Event.CREATED, (e) => {
                const layer = e.layer;
                items.addLayer(layer);
                setHasDrawnZone(true); // Set flag that a zone has been drawn
                
                // Generate a color based on zone type
                const colors = {
                    management: '#3388ff',
                    problem: '#ff0000',
                    sensitive: '#33cc33',
                    other: '#ffcc00'
                };
                
                layer.setStyle({
                    color: colors[zoneType] || '#3388ff',
                    fillColor: colors[zoneType] || '#3388ff',
                    fillOpacity: 0.2,
                    weight: 2
                });
                
                // Add popup with zone info
                layer.bindPopup(`<b>${zoneName || 'Unnamed zone'}</b><br>Type: ${zoneType}`);
            });
            
            setMap(newMap);
            setDrawnItems(items);
            setMapInitialized(true);
        }
        
        // Cleanup on unmount
        return () => {
            if (map) {
                map.remove();
            }
        };
    }, [mapInitialized, zoneType, zoneName]);
    
    // Add existing zones to map when they change
    useEffect(() => {
        if (map && drawnItems) {
            // Clear existing layers
            drawnItems.clearLayers();
            
            // Add each zone as a layer
            zones.forEach((zone, index) => {
                const layer = window.L.geoJSON(zone.coordinates);
                
                // Style based on zone type
                const colors = {
                    management: '#3388ff',
                    problem: '#ff0000',
                    sensitive: '#33cc33',
                    other: '#ffcc00'
                };
                
                layer.setStyle({
                    color: colors[zone.type] || '#3388ff',
                    fillColor: colors[zone.type] || '#3388ff',
                    fillOpacity: 0.2,
                    weight: 2
                });
                
                // Add popup with zone info
                layer.bindPopup(`
                    <b>${zone.name}</b><br>
                    Type: ${zone.type}<br>
                    ${zone.notes ? `Notes: ${zone.notes}` : ''}
                    <div class="mt-2">
                        <button onclick="window.editZone(${index})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">
                            Edit
                        </button>
                        <button onclick="window.deleteZone(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-xs ml-1">
                            Delete
                        </button>
                    </div>
                `);
                
                drawnItems.addLayer(layer);
            });
            
            // Fit map to show all zones if there are any
            if (zones.length > 0) {
                map.fitBounds(drawnItems.getBounds());
            }
        }
    }, [zones, map, drawnItems]);
    
    // Expose functions to window for popup buttons
    useEffect(() => {
        window.editZone = (index) => {
            setEditingZone(index);
            const zone = zones[index];
            setZoneName(zone.name);
            setZoneType(zone.type);
            setZoneNotes(zone.notes || '');
            setHasDrawnZone(true); // Assume we have a zone when editing
            
            // Highlight the zone being edited
            drawnItems.eachLayer(layer => {
                if (layer._leaflet_id === zones[index].coordinates.id) {
                    layer.setStyle({ weight: 4, fillOpacity: 0.3 });
                } else {
                    layer.setStyle({ weight: 2, fillOpacity: 0.2 });
                }
            });
        };
        
        window.deleteZone = (index) => {
            if (confirm('Are you sure you want to delete this zone?')) {
                removeZone(index);
                setHasDrawnZone(zones.length > 1); // Update flag based on remaining zones
            }
        };
        
        return () => {
            window.editZone = undefined;
            window.deleteZone = undefined;
        };
    }, [zones, removeZone, drawnItems]);
    
    const saveZone = () => {
        if (!zoneName) {
            alert('Please provide a zone name');
            return;
        }
        
        if (!hasDrawnZone && editingZone === null) {
            alert('Please draw a zone on the map first');
            return;
        }
        
        if (drawnItems) {
            const layers = drawnItems.getLayers();
            
            if (editingZone !== null) {
                // For editing, we don't need a new layer
                const updatedZone = {
                    name: zoneName,
                    type: zoneType,
                    notes: zoneNotes,
                    coordinates: zones[editingZone].coordinates // Keep existing coordinates
                };
                updateZone(editingZone, updatedZone);
                setEditingZone(null);
            } else if (layers.length > 0) {
                // For new zones, use the latest layer
                const latestLayer = layers[layers.length - 1];
                
                if (!latestLayer.toGeoJSON) {
                    alert('Error: Map data not ready. Please try drawing your zone again.');
                    return;
                }

                const zone = {
                    name: zoneName,
                    type: zoneType,
                    notes: zoneNotes,
                    coordinates: latestLayer.toGeoJSON().geometry
                };
                
                addZone(zone);
            }
            
            // Reset form
            setZoneName('');
            setZoneNotes('');
            setHasDrawnZone(false);
        }
    };
    
    const cancelEdit = () => {
        setEditingZone(null);
        setZoneName('');
        setZoneNotes('');
        setHasDrawnZone(zones.length > 0);
        
        // Reset layer styles
        if (drawnItems) {
            drawnItems.eachLayer(layer => {
                layer.setStyle({ weight: 2, fillOpacity: 0.2 });
            });
        }
    };
    
    return (
        <div className="max-w-6xl mx-auto">
            <h2 className="text-2xl font-bold mb-6 text-green-800">Map your property zones</h2>
            
            <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <p className="mb-6">Draw areas on the map to identify different zones (e.g., weed areas, sensitive ecosystems, planned works). Click on zones to edit or delete them.</p>
                
                <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label className="block text-sm font-medium mb-1 text-gray-700">
                            Zone name <span className="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            value={zoneName}
                            onChange={(e) => setZoneName(e.target.value)}
                            className="w-full p-2 border rounded-lg"
                            placeholder="e.g., North paddock weeds"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1 text-gray-700">
                            Zone type
                        </label>
                        <select
                            value={zoneType}
                            onChange={(e) => setZoneType(e.target.value)}
                            className="w-full p-2 border rounded-lg"
                        >
                            <option value="management">Management area</option>
                            <option value="problem">Problem area</option>
                            <option value="sensitive">Sensitive area</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1 text-gray-700">
                            Notes (optional)
                        </label>
                        <input
                            type="text"
                            value={zoneNotes}
                            onChange={(e) => setZoneNotes(e.target.value)}
                            className="w-full p-2 border rounded-lg"
                            placeholder="e.g., High priority area"
                        />
                    </div>
                    <div className="flex items-end space-x-2">
                        <button
                            onClick={saveZone}
                            disabled={!zoneName}
                            className={`px-4 py-2 rounded-lg flex-1 ${!zoneName ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                        >
                            {editingZone !== null ? 'Update Zone' : 'Save Zone'}
                        </button>
                        {editingZone !== null && (
                            <button
                                onClick={cancelEdit}
                                className="px-3 py-2 rounded-lg bg-gray-300 hover:bg-gray-400"
                            >
                                Cancel
                            </button>
                        )}
                    </div>
                </div>
                
                <div ref={mapRef} id="map" className="mb-6 rounded-lg overflow-hidden border border-gray-300"></div>
                
                <div>
                    <h3 className="font-medium mb-3 text-gray-800">Your saved zones:</h3>
                    {zones.length === 0 ? (
                        <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No zones saved yet. Draw on the map, fill in details above, and click "Save Zone".</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                        <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                        <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {zones.map((zone, index) => (
                                        <tr key={index} className={`${zone.type === 'management' ? 'bg-blue-50' : 
                                                                   zone.type === 'problem' ? 'bg-red-50' : 
                                                                   zone.type === 'sensitive' ? 'bg-green-50' : 'bg-yellow-50'}`}>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{zone.name}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 capitalize">{zone.type}</td>
                                            <td className="px-4 py-3 text-sm text-gray-500">{zone.notes || '-'}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                                <button 
                                                    onClick={() => {
                                                        setEditingZone(index);
                                                        const zone = zones[index];
                                                        setZoneName(zone.name);
                                                        setZoneType(zone.type);
                                                        setZoneNotes(zone.notes || '');
                                                        setHasDrawnZone(true);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-900 mr-3"
                                                >
                                                    Edit
                                                </button>
                                                <button 
                                                    onClick={() => {
                                                        if (confirm('Are you sure you want to delete this zone?')) {
                                                            removeZone(index);
                                                            setHasDrawnZone(zones.length > 1);
                                                        }
                                                    }}
                                                    className="text-red-600 hover:text-red-900"
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

        // Recommendations Component
        function Recommendations({ recommendations, problems }) {
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            const sortedRecs = [...recommendations].sort((a, b) => 
                priorityOrder[a.priority] - priorityOrder[b.priority]
            );
            
            return (
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-green-800">Your Custom Recommendations</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        {recommendations.length === 0 ? (
                            <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No recommendations generated. Please go back and provide more information about your property.</p>
                        ) : (
                            <div className="space-y-6">
                                {sortedRecs.map((rec, index) => (
                                    <div key={index} className="border-l-4 border-green-500 pl-4 py-3 bg-gray-50 rounded-r-lg">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-lg mb-2 text-green-800">{rec.title}</h3>
                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                rec.priority === 'high' ? 'bg-red-100 text-red-800' :
                                                rec.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-green-100 text-green-800'
                                            }`}>
                                                {rec.priority} priority
                                            </span>
                                        </div>
                                        <ul className="list-disc list-inside space-y-2 pl-2">
                                            {rec.actions.map((action, i) => (
                                                <li key={i} className="text-gray-700">{action}</li>
                                            ))}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Timeline Component
        function Timeline({ timeline, recommendations }) {
            const now = new Date();
            const currentMonth = now.getMonth();
            
            // Australian seasons
            const getSeason = (month) => {
                if (month >= 11 || month <= 1) return 'Summer';
                if (month >= 2 && month <= 4) return 'Autumn';
                if (month >= 5 && month <= 7) return 'Winter';
                return 'Spring';
            };
            
            const currentSeason = getSeason(currentMonth);
            
            // Group timeline items by timeframe
            const timeframes = {
                immediate: timeline.filter(item => item.timeframe === 'Immediate'),
                '1-3 months': timeline.filter(item => item.timeframe === '1-3 months'),
                '3-6 months': timeline.filter(item => item.timeframe === '3-6 months'),
                '6-12 months': timeline.filter(item => item.timeframe === '6-12 months'),
                '12+ months': timeline.filter(item => item.timeframe.includes('12'))
            };
            
            return (
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-green-800">Action Timeline</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div className="mb-6">
                            <h3 className="text-lg font-medium mb-3 text-gray-800">Current Season: {currentSeason}</h3>
                            <p className="text-sm text-gray-600">The timeline below suggests when to implement actions based on seasonal considerations.</p>
                        </div>
                        
                        {timeline.length === 0 ? (
                            <p className="text-gray-500 p-4 bg-gray-50 rounded-lg">No timeline generated. Please go back and provide more information about your property.</p>
                        ) : (
                            <div className="space-y-8">
                                {Object.entries(timeframes).map(([timeframe, items]) => (
                                    items.length > 0 && (
                                        <div key={timeframe}>
                                            <h4 className="font-bold text-md mb-3 border-b pb-2 text-gray-700">
                                                {timeframe === 'immediate' ? 'Immediate Actions' : `Within ${timeframe}`}
                                            </h4>
                                            <div className="space-y-3">
                                                {items.map((item, index) => (
                                                    <div key={index} className="flex items-start p-3 rounded-lg border border-gray-200 hover:bg-gray-50">
                                                        <div className={`flex-shrink-0 h-5 w-5 rounded-full mt-1 ${
                                                            item.priority === 'high' ? 'bg-red-500' :
                                                            item.priority === 'medium' ? 'bg-yellow-500' :
                                                            'bg-green-500'
                                                        }`}></div>
                                                        <div className="ml-3">
                                                            <p className="text-sm font-medium text-gray-900">{item.action}</p>
                                                            <p className="text-sm text-gray-500">Best season: {item.season} ‚Ä¢ Priority: {item.priority}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Export Panel Component
        function ExportPanel({ formData }) {
            const [includeMap, setIncludeMap] = useState(true);
            const [includeImages, setIncludeImages] = useState(false);
            const [planName, setPlanName] = useState(`LEAP_Plan_${formData.property.name || 'Property'}`);
            
            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set document properties
                doc.setProperties({
                    title: `LEAP Plan - ${formData.property.name || 'Property'}`,
                    subject: 'Landholder Environmental Action Plan',
                    author: 'LEAP Tool',
                    keywords: 'environment, action plan, land management',
                    creator: 'LEAP'
                });
                
                // Title page
                doc.setFontSize(24);
                doc.setTextColor(0, 100, 0);
                doc.text('Landholder Environmental Action Plan', 105, 30, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text(`Prepared for: ${formData.property.name || 'Unnamed Property'}`, 105, 50, { align: 'center' });
                doc.text(`Date: ${formatDate(new Date())}`, 105, 60, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text('Generated by the LEAP (Landholder Environmental Action Planner) tool', 105, 280, { align: 'center' });
                
                // Add new page for property details
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(0, 100, 0);
                doc.text('1. Property Details', 20, 20);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Property Name: ${formData.property.name || 'Not specified'}`, 20, 35);
                doc.text(`Location: ${formData.property.location || 'Not specified'}`, 20, 45);
                doc.text(`Size: ${formData.property.size || 'Not specified'} hectares`, 20, 55);
                doc.text(`State: ${formData.property.state || 'Not specified'}`, 20, 65);
                doc.text(`Rainfall: ${formData.property.rainfall || 'Not specified'}`, 20, 75);
                doc.text(`Soil Type: ${formData.property.soilType || 'Not specified'}`, 20, 85);
                
                doc.text('Property Features:', 20, 100);
                let featureY = 110;
                formData.property.features.forEach(feature => {
                    doc.text(`‚Ä¢ ${feature}`, 25, featureY);
                    featureY += 7;
                });
                
                // Problems page
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(0, 100, 0);
                doc.text('2. Identified Issues', 20, 20);
                
                doc.setFontSize(12);
                let problemY = 35;
                
                if (formData.problems.erosion.present) {
                    doc.text(`‚Ä¢ Soil erosion (${formData.problems.erosion.severity} severity)`, 20, problemY);
                    problemY += 7;
                }
                
                if (formData.problems.weeds.length > 0) {
                    doc.text(`‚Ä¢ Weed problems: ${formData.problems.weeds.join(', ')}`, 20, problemY);
                    problemY += 7;
                }
                
                if (formData.problems.habitatLoss.present) {
                    doc.text(`‚Ä¢ Habitat loss/degradation (${formData.problems.habitatLoss.severity} severity)`, 20, problemY);
                    problemY += 7;
                }
                
                if (formData.problems.waterQuality.present) {
                    doc.text(`‚Ä¢ Water quality concerns (${formData.problems.waterQuality.severity} severity)`, 20, problemY);
                    problemY += 7;
                }
                
                if (formData.problems.fireRisk.present) {
                    doc.text(`‚Ä¢ Bushfire risk (${formData.problems.fireRisk.severity} severity)`, 20, problemY);
                    problemY += 7;
                }
                
                if (formData.problems.otherProblems) {
                    doc.text(`‚Ä¢ Other concerns: ${formData.problems.otherProblems}`, 20, problemY);
                    problemY += 7;
                }
                
                // Management goals
                doc.setFontSize(18);
                doc.setTextColor(0, 100, 0);
                doc.text('3. Management Goals', 20, problemY + 15);
                
                doc.setFontSize(12);
                let goalY = problemY + 30;
                formData.problems.goals.forEach(goal => {
                    doc.text(`‚Ä¢ ${goal}`, 20, goalY);
                    goalY += 7;
                });
                
                // Recommendations
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(0, 100, 0);
                doc.text('4. Recommended Actions', 20, 20);
                
                doc.setFontSize(12);
                let recY = 35;
                formData.recommendations.forEach(rec => {
                    doc.setFont(undefined, 'bold');
                    doc.text(`${rec.title}:`, 20, recY);
                    doc.setFont(undefined, 'normal');
                    recY += 7;
                    
                    rec.actions.forEach(action => {
                        doc.text(`‚Ä¢ ${action}`, 25, recY);
                        recY += 7;
                        if (recY > 280) {
                            doc.addPage();
                            recY = 20;
                        }
                    });
                    recY += 5;
                });
                
                // Timeline
                doc.addPage();
                doc.setFontSize(18);
                doc.setTextColor(0, 100, 0);
                doc.text('5. Action Timeline', 20, 20);
                
                doc.setFontSize(12);
                let timeY = 35;
                
                const timeGroups = {
                    'Immediate Actions': formData.timeline.filter(item => item.timeframe === 'Immediate'),
                    'Short Term (1-6 months)': formData.timeline.filter(item => 
                        item.timeframe === '1-3 months' || item.timeframe === '3-6 months'),
                    'Medium Term (6-12 months)': formData.timeline.filter(item => 
                        item.timeframe === '6-12 months'),
                    'Long Term (12+ months)': formData.timeline.filter(item => 
                        item.timeframe.includes('12'))
                };
                
                Object.entries(timeGroups).forEach(([title, items]) => {
                    if (items.length > 0) {
                        doc.setFont(undefined, 'bold');
                        doc.text(title, 20, timeY);
                        doc.setFont(undefined, 'normal');
                        timeY += 7;
                        
                        items.forEach(item => {
                            doc.text(`‚Ä¢ ${item.action} (Best in ${item.season}, ${item.priority} priority)`, 25, timeY);
                            timeY += 7;
                            if (timeY > 280) {
                                doc.addPage();
                                timeY = 20;
                            }
                        });
                        
                        timeY += 5;
                    }
                });
                
                // Save the PDF
                doc.save(`${planName}.pdf`);
            };
            
            return (
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-green-800">Export Your Action Plan</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 className="text-xl font-medium mb-4 text-gray-800">Your plan is ready!</h3>
                        <p className="mb-6">Download your customized environmental action plan as a PDF document.</p>
                        
                        <div className="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                            <h4 className="font-bold mb-4 text-lg">Plan Summary</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 className="font-medium mb-2 text-gray-700">Property Details</h5>
                                    <ul className="space-y-1 text-sm">
                                        <li><span className="font-medium">Name:</span> {formData.property.name || 'Not specified'}</li>
                                        <li><span className="font-medium">Location:</span> {formData.property.location || 'Not specified'}</li>
                                        <li><span className="font-medium">Size:</span> {formData.property.size || 'Not specified'} hectares</li>
                                        <li><span className="font-medium">Features:</span> {formData.property.features.join(', ') || 'None specified'}</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 className="font-medium mb-2 text-gray-700">Plan Contents</h5>
                                    <ul className="space-y-1 text-sm">
                                        <li><span className="font-medium">Identified issues:</span> {formData.timeline.length} priority actions</li>
                                        <li><span className="font-medium">Mapped zones:</span> {formData.mapZones.length} areas</li>
                                        <li><span className="font-medium">Recommendations:</span> {formData.recommendations.length} categories</li>
                                        <li><span className="font-medium">Timeline:</span> {formData.timeline.length} scheduled actions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mb-8">
                            <h4 className="font-bold mb-4 text-lg">Export Options</h4>
                            <div className="space-y-4">
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="include-map"
                                        checked={includeMap}
                                        onChange={() => setIncludeMap(!includeMap)}
                                        className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                    />
                                    <label htmlFor="include-map" className="ml-2 block text-sm text-gray-700">
                                        Include property map in PDF
                                    </label>
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="include-images"
                                        checked={includeImages}
                                        onChange={() => setIncludeImages(!includeImages)}
                                        className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                    />
                                    <label htmlFor="include-images" className="ml-2 block text-sm text-gray-700">
                                        Include example images (where available)
                                    </label>
                                </div>
                                <div>
                                    <label htmlFor="plan-name" className="block text-sm font-medium text-gray-700 mb-1">
                                        Plan file name
                                    </label>
                                    <input
                                        type="text"
                                        id="plan-name"
                                        value={planName}
                                        onChange={(e) => setPlanName(e.target.value)}
                                        className="w-full p-2 border rounded-lg"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex flex-col sm:flex-row gap-4">
                            <button
                                onClick={generatePDF}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex-1 flex items-center justify-center"
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Download PDF Plan
                            </button>
                            <button
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex-1 flex items-center justify-center"
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                Email Plan
                            </button>
                        </div>
                        
                        <div className="mt-8 pt-6 border-t border-gray-200">
                            <h4 className="font-bold mb-3 text-lg">Next Steps</h4>
                            <ul className="space-y-2 text-sm text-gray-700">
                                <li className="flex items-start">
                                    <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Review your plan and prioritize actions
                                </li>
                                <li className="flex items-start">
                                    <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Contact local Landcare or NRM group for support
                                </li>
                                <li className="flex items-start">
                                    <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Check for available grants or funding programs
                                </li>
                                <li className="flex items-start">
                                    <svg className="flex-shrink-0 h-5 w-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Schedule regular reviews of your progress
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
